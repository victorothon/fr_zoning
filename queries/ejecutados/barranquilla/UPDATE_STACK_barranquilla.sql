
---------------------------------
-- UPDATE: OVFR_COL: AdvertsStack 
---------------------------------

-- Inmobiliarias

UPDATE DESTINO
SET Attempts         = 0,
    Fk_StatusStackId = 0,
    StackDate        = GETDATE(),
    Exception        = '',
    AlertType        = temp.AlertType
--SELECT *
FROM OVFR_COL..StackAd DESTINO
         INNER JOIN (
            SELECT A.Pk_Id AS Fk_AdId, 1 AS AlertType
            FROM OVFR_COL..Inmo I (NOLOCK)
                INNER JOIN OVFR_COL..Ad A (NOLOCK) ON A.Pk_Id = I.Pk_Id AND A.Fk_StatusId = 2
            WHERE A.Fk_LocalizationLevel4Id IN (5700101,5700102,5700103,5700104,5700105)
                AND A.Fk_LocalizationLevel5Id IN (5701001,5701002,5701003,5701004,5701005,5701006,5701007,5701008,5701009,5701010,5701011,5701012,5701013,5701014,5701015,5701016,5701017,5701018,5701019,5701020,5701021,5701022,5701023,5701024,5701025,5701026,5701027,5701028,5701029,5701030,5701031,5701032,5701033,5701034,5701035,5701036,5701037,5701038,5701039,5701040,5701041,5701042,5701043,5701044,5701045,5701046,5701047,5701048,5701049,5701050,5701051,5701052,5701053,5701054,5701055,5701056,5701057,5701058,5701059,5701060,5701061,5701062,5701063,5701064,5701065,5701066,5701067,5701068,5701069,5701070,5701071,5701072,5701073,5701074,5701075,5701076,5701077,5701078,5701079,5701080,5701081,5701082,5701083,5701084,5701085,5701086,5701087,5701088,5701089,5701090,5701091,5701092,5701093,5701094,5701095,5701096,5701097,5701098,5701099,5701100,5701101,5701102,5701103,5701104,5701105,5701106,5701107,5701108,5701109,5701110,5701111,5701112,5701113,5701114,5701115,5701116,5701117,5701118,5701119,5701120,5701121,5701122,5701123,5701124,5701125,5701126,5701127,5701128,5701129,5701130,5701131,5701132,5701133,5701134,5701135,5701136,5701137,5701138,5701139,5701140,5701141,5701142,5701143,5701144,5701145,5701146,5701147,5701148,5701149,5701150,5701151,5701152,5701153,5701154,5701155,5701156,5701157,5701158,5701159,5701160)
) AS TEMP ON TEMP.Fk_AdId = DESTINO.Fk_AdId 
            AND TEMP.AlertType = DESTINO.AlertType

-- Proyectos

UPDATE DESTINO
SET Attempts         = 0,
    Fk_StatusStackId = 0,
    StackDate        = GETDATE(),
    Exception        = '',
    AlertType        = temp.AlertType
FROM OVFR_COL..StackAd DESTINO
         INNER JOIN (
            SELECT A.Pk_Id AS Fk_AdId, 2 AS AlertType
            FROM OVFR_COL..Project P (NOLOCK)
                INNER JOIN OVFR_COL..Ad A ON A.Pk_Id = P.Pk_Id
            WHERE A.Fk_LocalizationLevel4Id IN (5700101,5700102,5700103,5700104,5700105) 
                AND A.Fk_LocalizationLevel5Id IN (5701001,5701002,5701003,5701004,5701005,5701006,5701007,5701008,5701009,5701010,5701011,5701012,5701013,5701014,5701015,5701016,5701017,5701018,5701019,5701020,5701021,5701022,5701023,5701024,5701025,5701026,5701027,5701028,5701029,5701030,5701031,5701032,5701033,5701034,5701035,5701036,5701037,5701038,5701039,5701040,5701041,5701042,5701043,5701044,5701045,5701046,5701047,5701048,5701049,5701050,5701051,5701052,5701053,5701054,5701055,5701056,5701057,5701058,5701059,5701060,5701061,5701062,5701063,5701064,5701065,5701066,5701067,5701068,5701069,5701070,5701071,5701072,5701073,5701074,5701075,5701076,5701077,5701078,5701079,5701080,5701081,5701082,5701083,5701084,5701085,5701086,5701087,5701088,5701089,5701090,5701091,5701092,5701093,5701094,5701095,5701096,5701097,5701098,5701099,5701100,5701101,5701102,5701103,5701104,5701105,5701106,5701107,5701108,5701109,5701110,5701111,5701112,5701113,5701114,5701115,5701116,5701117,5701118,5701119,5701120,5701121,5701122,5701123,5701124,5701125,5701126,5701127,5701128,5701129,5701130,5701131,5701132,5701133,5701134,5701135,5701136,5701137,5701138,5701139,5701140,5701141,5701142,5701143,5701144,5701145,5701146,5701147,5701148,5701149,5701150,5701151,5701152,5701153,5701154,5701155,5701156,5701157,5701158,5701159,5701160)
                AND A.Fk_StatusId = 2
) AS TEMP ON TEMP.Fk_AdId = DESTINO.Fk_AdId 
            AND TEMP.AlertType = DESTINO.AlertType

-- Tipologías

UPDATE DESTINO
SET Attempts         = 0,
    Fk_StatusStackId = 0,
    StackDate        = GETDATE(),
    Exception        = '',
    AlertType        = temp.AlertType
FROM OVFR_COL..StackAd DESTINO
         INNER JOIN (
            SELECT A.Pk_Id AS Fk_AdId, 2 as AlertType
            FROM OVFR_COL..Project P (NOLOCK)
                INNER JOIN OVFR_COL..Ad A ON A.Pk_Id = P.Pk_Id
                INNER JOIN OVFR_COL..UnitType U ON U.Fk_IdProject = A.Pk_Id 
            WHERE A.Fk_LocalizationLevel4Id IN (5700101,5700102,5700103,5700104,5700105)
                AND A.Fk_LocalizationLevel5Id IN (5701001,5701002,5701003,5701004,5701005,5701006,5701007,5701008,5701009,5701010,5701011,5701012,5701013,5701014,5701015,5701016,5701017,5701018,5701019,5701020,5701021,5701022,5701023,5701024,5701025,5701026,5701027,5701028,5701029,5701030,5701031,5701032,5701033,5701034,5701035,5701036,5701037,5701038,5701039,5701040,5701041,5701042,5701043,5701044,5701045,5701046,5701047,5701048,5701049,5701050,5701051,5701052,5701053,5701054,5701055,5701056,5701057,5701058,5701059,5701060,5701061,5701062,5701063,5701064,5701065,5701066,5701067,5701068,5701069,5701070,5701071,5701072,5701073,5701074,5701075,5701076,5701077,5701078,5701079,5701080,5701081,5701082,5701083,5701084,5701085,5701086,5701087,5701088,5701089,5701090,5701091,5701092,5701093,5701094,5701095,5701096,5701097,5701098,5701099,5701100,5701101,5701102,5701103,5701104,5701105,5701106,5701107,5701108,5701109,5701110,5701111,5701112,5701113,5701114,5701115,5701116,5701117,5701118,5701119,5701120,5701121,5701122,5701123,5701124,5701125,5701126,5701127,5701128,5701129,5701130,5701131,5701132,5701133,5701134,5701135,5701136,5701137,5701138,5701139,5701140,5701141,5701142,5701143,5701144,5701145,5701146,5701147,5701148,5701149,5701150,5701151,5701152,5701153,5701154,5701155,5701156,5701157,5701158,5701159,5701160)
                AND A.Fk_StatusId = 2
                AND U.Fk_IdProject <> 0
) AS TEMP ON TEMP.Fk_AdId = DESTINO.Fk_AdId 
            AND TEMP.AlertType = DESTINO.AlertType

---------------------------------
-- INSERT: OVFR_COL: AdvertsStack
---------------------------------

-- Inmobiliarias
INSERT INTO OVFR_COL..StackAd
SELECT TEMP.Pk_Id       AS      Fk_AdId,
       0                AS      Fk_UnitTypeId,
       2                AS      Fk_StatusStackId,
       GETDATE()        AS      StackDate,
       0                AS      Attempts,
       NULL             AS      Exception,
       TEMP.AlertType   AS      AlertType,
       NULL             AS      ReprocessedAfterError
FROM ( 
    SELECT A.Pk_Id AS Pk_Id, 1 AS AlertType
        FROM OVFR_COL..Inmo I (NOLOCK)
            INNER JOIN OVFR_COL..Ad A ON A.Pk_Id = I.Pk_Id
            LEFT JOIN OVFR_COL..StackAd S ON S.Fk_AdId = I.Pk_Id
        WHERE A.Fk_LocalizationLevel4Id IN (5700101,5700102,5700103,5700104,5700105)
            AND A.Fk_LocalizationLevel5Id IN (5701001,5701002,5701003,5701004,5701005,5701006,5701007,5701008,5701009,5701010,5701011,5701012,5701013,5701014,5701015,5701016,5701017,5701018,5701019,5701020,5701021,5701022,5701023,5701024,5701025,5701026,5701027,5701028,5701029,5701030,5701031,5701032,5701033,5701034,5701035,5701036,5701037,5701038,5701039,5701040,5701041,5701042,5701043,5701044,5701045,5701046,5701047,5701048,5701049,5701050,5701051,5701052,5701053,5701054,5701055,5701056,5701057,5701058,5701059,5701060,5701061,5701062,5701063,5701064,5701065,5701066,5701067,5701068,5701069,5701070,5701071,5701072,5701073,5701074,5701075,5701076,5701077,5701078,5701079,5701080,5701081,5701082,5701083,5701084,5701085,5701086,5701087,5701088,5701089,5701090,5701091,5701092,5701093,5701094,5701095,5701096,5701097,5701098,5701099,5701100,5701101,5701102,5701103,5701104,5701105,5701106,5701107,5701108,5701109,5701110,5701111,5701112,5701113,5701114,5701115,5701116,5701117,5701118,5701119,5701120,5701121,5701122,5701123,5701124,5701125,5701126,5701127,5701128,5701129,5701130,5701131,5701132,5701133,5701134,5701135,5701136,5701137,5701138,5701139,5701140,5701141,5701142,5701143,5701144,5701145,5701146,5701147,5701148,5701149,5701150,5701151,5701152,5701153,5701154,5701155,5701156,5701157,5701158,5701159,5701160)
            AND S.Fk_AdId IS NULL
            AND A.Fk_StatusId = 2
    ) AS TEMP

-- Proyectos

INSERT INTO OVFR_COL..StackAd
SELECT TEMP.Pk_Id       AS      Fk_AdId,
       0                AS      Fk_UnitTypeId,
       2                AS      Fk_StatusStackId,
       GETDATE()        AS      StackDate,
       0                AS      Attempts,
       NULL             AS      Exception,
       TEMP.AlertType   AS      AlertType,
       NULL             AS      ReprocessedAfterError
FROM (
    SELECT A.Pk_Id AS Pk_Id, 2 AS AlertType
    FROM OVFR_COL..Project P (NOLOCK)
        INNER JOIN OVFR_COL..Ad A ON A.Pk_Id = P.Pk_Id
        LEFT JOIN OVFR_COL..StackAd S ON S.Fk_AdId = A.Pk_Id
    WHERE A.Fk_LocalizationLevel4Id IN (5700101,5700102,5700103,5700104,5700105)
        AND A.Fk_LocalizationLevel5Id IN (5701001,5701002,5701003,5701004,5701005,5701006,5701007,5701008,5701009,5701010,5701011,5701012,5701013,5701014,5701015,5701016,5701017,5701018,5701019,5701020,5701021,5701022,5701023,5701024,5701025,5701026,5701027,5701028,5701029,5701030,5701031,5701032,5701033,5701034,5701035,5701036,5701037,5701038,5701039,5701040,5701041,5701042,5701043,5701044,5701045,5701046,5701047,5701048,5701049,5701050,5701051,5701052,5701053,5701054,5701055,5701056,5701057,5701058,5701059,5701060,5701061,5701062,5701063,5701064,5701065,5701066,5701067,5701068,5701069,5701070,5701071,5701072,5701073,5701074,5701075,5701076,5701077,5701078,5701079,5701080,5701081,5701082,5701083,5701084,5701085,5701086,5701087,5701088,5701089,5701090,5701091,5701092,5701093,5701094,5701095,5701096,5701097,5701098,5701099,5701100,5701101,5701102,5701103,5701104,5701105,5701106,5701107,5701108,5701109,5701110,5701111,5701112,5701113,5701114,5701115,5701116,5701117,5701118,5701119,5701120,5701121,5701122,5701123,5701124,5701125,5701126,5701127,5701128,5701129,5701130,5701131,5701132,5701133,5701134,5701135,5701136,5701137,5701138,5701139,5701140,5701141,5701142,5701143,5701144,5701145,5701146,5701147,5701148,5701149,5701150,5701151,5701152,5701153,5701154,5701155,5701156,5701157,5701158,5701159,5701160)
        AND S.Fk_AdId IS NULL
        AND A.Fk_StatusId = 2
    ) AS TEMP

-- Tipologías

INSERT INTO OVFR_COL..StackAd
SELECT TEMP.Pk_AdId         AS      Fk_AdId,
       TEMP.Fk_UnitTypeId   AS      Fk_UnitTypeId,
       2                    AS      Fk_StatusStackId,
       GETDATE()            AS      StackDate,
       0                    AS      Attempts,
       NULL                 AS      Exception,
       TEMP.AlertType       AS      AlertType,
       NULL                 AS      ReprocessedAfterError
FROM 
      (
        SELECT A.Pk_Id AS Pk_AdId, U.Pk_Id Fk_UnitTypeId, 2 as AlertType
        FROM OVFR_COL..Ad A (NOLOCK)
            INNER JOIN OVFR_COL..Project P ON A.Pk_Id = P.Pk_Id
            INNER JOIN OVFR_COL..UnitType U ON U.Fk_IdProject = A.Pk_Id
            LEFT JOIN OVFR_COL..StackAd S ON S.Fk_AdId = A.Pk_Id AND S.Fk_UnitTypeId = U.Pk_Id
            WHERE A.Fk_LocalizationLevel4Id IN (5700101,5700102,5700103,5700104,5700105) 
                AND A.Fk_LocalizationLevel5Id IN (5701001,5701002,5701003,5701004,5701005,5701006,5701007,5701008,5701009,5701010,5701011,5701012,5701013,5701014,5701015,5701016,5701017,5701018,5701019,5701020,5701021,5701022,5701023,5701024,5701025,5701026,5701027,5701028,5701029,5701030,5701031,5701032,5701033,5701034,5701035,5701036,5701037,5701038,5701039,5701040,5701041,5701042,5701043,5701044,5701045,5701046,5701047,5701048,5701049,5701050,5701051,5701052,5701053,5701054,5701055,5701056,5701057,5701058,5701059,5701060,5701061,5701062,5701063,5701064,5701065,5701066,5701067,5701068,5701069,5701070,5701071,5701072,5701073,5701074,5701075,5701076,5701077,5701078,5701079,5701080,5701081,5701082,5701083,5701084,5701085,5701086,5701087,5701088,5701089,5701090,5701091,5701092,5701093,5701094,5701095,5701096,5701097,5701098,5701099,5701100,5701101,5701102,5701103,5701104,5701105,5701106,5701107,5701108,5701109,5701110,5701111,5701112,5701113,5701114,5701115,5701116,5701117,5701118,5701119,5701120,5701121,5701122,5701123,5701124,5701125,5701126,5701127,5701128,5701129,5701130,5701131,5701132,5701133,5701134,5701135,5701136,5701137,5701138,5701139,5701140,5701141,5701142,5701143,5701144,5701145,5701146,5701147,5701148,5701149,5701150,5701151,5701152,5701153,5701154,5701155,5701156,5701157,5701158,5701159,5701160)
                AND S.Fk_AdId Is NULL
                AND A.Fk_StatusId = 2
        ) AS TEMP
    

--------------------------
--------------------------
--FC Stack Update & Insert
--------------------------
--------------------------

-- Update

UPDATE Destino
SET [Date] = GETDATE(),
    [Priority] = 0,
    [Attempts] = 0,
    [Status] = 0 
FROM FC_COL_AUX..AdvertsStack Destino
    INNER JOIN (
        SELECT MAX(S.PK_AdvertsStackId) PK_AdvertsStackId, S.AdvertId
        FROM FC_COL_AUX..AdvertsStack S
            INNER JOIN FC_COL_WRT..AdvertsRealstate R ON S.AdvertId = R.PK_AdvertId
            INNER JOIN FC_COL_WRT..Adverts A ON R.PK_AdvertId = A.PK_AdvertId
        WHERE R.Fk_Location3Id IN (5700101,5700102,5700103,5700104,5700105)
            AND R.FK_Location4Id IN (5701001,5701002,5701003,5701004,5701005,5701006,5701007,5701008,5701009,5701010,5701011,5701012,5701013,5701014,5701015,5701016,5701017,5701018,5701019,5701020,5701021,5701022,5701023,5701024,5701025,5701026,5701027,5701028,5701029,5701030,5701031,5701032,5701033,5701034,5701035,5701036,5701037,5701038,5701039,5701040,5701041,5701042,5701043,5701044,5701045,5701046,5701047,5701048,5701049,5701050,5701051,5701052,5701053,5701054,5701055,5701056,5701057,5701058,5701059,5701060,5701061,5701062,5701063,5701064,5701065,5701066,5701067,5701068,5701069,5701070,5701071,5701072,5701073,5701074,5701075,5701076,5701077,5701078,5701079,5701080,5701081,5701082,5701083,5701084,5701085,5701086,5701087,5701088,5701089,5701090,5701091,5701092,5701093,5701094,5701095,5701096,5701097,5701098,5701099,5701100,5701101,5701102,5701103,5701104,5701105,5701106,5701107,5701108,5701109,5701110,5701111,5701112,5701113,5701114,5701115,5701116,5701117,5701118,5701119,5701120,5701121,5701122,5701123,5701124,5701125,5701126,5701127,5701128,5701129,5701130,5701131,5701132,5701133,5701134,5701135,5701136,5701137,5701138,5701139,5701140,5701141,5701142,5701143,5701144,5701145,5701146,5701147,5701148,5701149,5701150,5701151,5701152,5701153,5701154,5701155,5701156,5701157,5701158,5701159,5701160)
            AND A.[Status] = 2
        GROUP BY S.AdvertId
    ) AS TEMP ON TEMP.PK_AdvertsStackId = Destino.PK_AdvertsStackId

-- Insert

INSERT INTO FC_COL_AUX..AdvertsStack
SELECT  R.PK_AdvertId   AS  AdvertId, 
        2               AS  AdvertCategoryId,
        A.FK_ClientId   AS  ClientId,
        GETDATE()       AS  [Date],
        0               AS  Priority,
        0               AS  Attempts,
        0               AS  [Status]
FROM FC_COL_AUX..AdvertsStack S (NOLOCK)
    RIGHT JOIN FC_COL_WRT..AdvertsRealstate R ON S.AdvertId = R.PK_AdvertId
    INNER JOIN FC_COL_WRT..Adverts A ON R.PK_AdvertId = A.PK_AdvertId
WHERE R.Fk_Location3Id IN (5700101,5700102,5700103,5700104,5700105) 
    AND FK_Location4Id IN (5701001,5701002,5701003,5701004,5701005,5701006,5701007,5701008,5701009,5701010,5701011,5701012,5701013,5701014,5701015,5701016,5701017,5701018,5701019,5701020,5701021,5701022,5701023,5701024,5701025,5701026,5701027,5701028,5701029,5701030,5701031,5701032,5701033,5701034,5701035,5701036,5701037,5701038,5701039,5701040,5701041,5701042,5701043,5701044,5701045,5701046,5701047,5701048,5701049,5701050,5701051,5701052,5701053,5701054,5701055,5701056,5701057,5701058,5701059,5701060,5701061,5701062,5701063,5701064,5701065,5701066,5701067,5701068,5701069,5701070,5701071,5701072,5701073,5701074,5701075,5701076,5701077,5701078,5701079,5701080,5701081,5701082,5701083,5701084,5701085,5701086,5701087,5701088,5701089,5701090,5701091,5701092,5701093,5701094,5701095,5701096,5701097,5701098,5701099,5701100,5701101,5701102,5701103,5701104,5701105,5701106,5701107,5701108,5701109,5701110,5701111,5701112,5701113,5701114,5701115,5701116,5701117,5701118,5701119,5701120,5701121,5701122,5701123,5701124,5701125,5701126,5701127,5701128,5701129,5701130,5701131,5701132,5701133,5701134,5701135,5701136,5701137,5701138,5701139,5701140,5701141,5701142,5701143,5701144,5701145,5701146,5701147,5701148,5701149,5701150,5701151,5701152,5701153,5701154,5701155,5701156,5701157,5701158,5701159,5701160)
    AND S.AdvertId IS NULL
    AND A.[Status] = 2
