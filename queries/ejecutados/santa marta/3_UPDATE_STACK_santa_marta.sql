
---------------------------------
-- UPDATE: OVFR_COL: AdvertsStack 
---------------------------------

-- Inmobiliarias

UPDATE DESTINO
SET Attempts         = 0,
    Fk_StatusStackId = 0,
    StackDate        = GETDATE(),
    Exception        = '',
    AlertType        = temp.AlertType
--SELECT *
FROM OVFR_COL..StackAd DESTINO
         INNER JOIN (
            SELECT A.Pk_Id AS Fk_AdId, 1 AS AlertType
            FROM OVFR_COL..Inmo I (NOLOCK)
                INNER JOIN OVFR_COL..Ad A (NOLOCK) ON A.Pk_Id = I.Pk_Id AND A.Fk_StatusId = 2
            WHERE A.Fk_LocalizationLevel4Id IN (7200101,7200102,7200103,7200104,7200105,7200106,7200107,7200108,7200109,7200110,7200111,7200112,7200113)
                AND A.Fk_LocalizationLevel5Id IN (7201001,7201002,7201003,7201004,7201005,7201006,7201007,7201008,7201009,7201010,7201011,7201012,7201013,7201014,7201015,7201016,7201017,7201018,7201019,7201020,7201021,7201022,7201023,7201024,7201025,7201026,7201027,7201028,7201029,7201030,7201031,7201032,7201033,7201034,7201035,7201036,7201037,7201038,7201039,7201040,7201041,7201042,7201043,7201044,7201045,7201046,7201047,7201048,7201049,7201050,7201051,7201052,7201053,7201054,7201055,7201056,7201057,7201058,7201059,7201060,7201061,7201062,7201063,7201064,7201065,7201066,7201067,7201068,7201069,7201070,7201071,7201072,7201073,7201074,7201075,7201076,7201077,7201078,7201079,7201080,7201081,7201082,7201083,7201084,7201085,7201086,7201087,7201088,7201089,7201090,7201091,7201092,7201093,7201094,7201095,7201096,7201097,7201098,7201099,7201100,7201101,7201102,7201103,7201104,7201105,7201106,7201107,7201108,7201109,7201110,7201111,7201112,7201113,7201114,7201115,7201116,7201117,7201118,7201119,7201120,7201121,7201122,7201123,7201124,7201125,7201126,7201127,7201128,7201129,7201130,7201131,7201132,7201133,7201134,7201135,7201136,7201137,7201138,7201139,7201140,7201141,7201142,7201143,7201144,7201145,7201146,7201147,7201148,7201149,7201150,7201151,7201152,7201153,7201154,7201155,7201156,7201157,7201158,7201159,7201160,7201161,7201162,7201163,7201164,7201165,7201166,7201167,7201168,7201169,7201170,7201171,7201172,7201173,7201174,7201175,7201176,7201177,7201178,7201179,7201180,7201181,7201182,7201183,7201184,7201185,7201186,7201187,7201188,7201189,7201190,7201191,7201192,7201193,7201194,7201195,7201196,7201197,7201198,7201199,7201200,7201201,7201202,7201203,7201204,7201205,7201206,7201207,7201208,7201209,7201210,7201211,7201212,7201213,7201214,7201215,7201216,7201217,7201218,7201219,7201220,7201221,7201222,7201223,7201224,7201225,7201226,7201227,7201228,7201229,7201230,7201231,7201232,7201233,7201234,7201235,7201236,7201237,7201238,7201239,7201240,7201241,7201242,7201243,7201244,7201245,7201246,7201247,7201248,7201249,7201250,7201251,7201252,7201253,7201254,7201255,7201256,7201257,7201258,7201259,7201260,7201261,7201262,7201263,7201264,7201265,7201266,7201267,7201268,7201269,7201270,7201271,7201272,7201273,7201274,7201275,7201276,7201277,7201278,7201279,7201280,7201281,7201282,7201283,7201284,7201285,7201286,7201287,7201288,7201289,7201290,7201291,7201292,7201293,7201294,7201295,7201296,7201297,7201298,7201299,7201300,7201301,7201302,7201303,7201304,7201305,7201306,7201307,7201308,7201309,7201310,7201311,7201312,7201313,7201314,7201315,7201316,7201317,7201318,7201319,7201320,7201321,7201322,7201323,7201324,7201325,7201326,7201327,7201328,7201329,7201330,7201331,7201332,7201333,7201334,7201335,7201336,7201337,7201338,7201339,7201340,7201341,7201342,7201343,7201344,7201345,7201346,7201347,7201348,7201349,7201350,7201351,7201352,7201353,7201354,7201355,7201356,7201357,7201358,7201359,7201360,7201361,7201362,7201363,7201364,7201365,7201366,7201367,7201368,7201369,7201370,7201371,7201372,7201373,7201374,7201375,7201376,7201377,7201378,7201379,7201380,7201381,7201382,7201383,7201384)
) AS TEMP ON TEMP.Fk_AdId = DESTINO.Fk_AdId 
            AND TEMP.AlertType = DESTINO.AlertType

-- Proyectos

UPDATE DESTINO
SET Attempts         = 0,
    Fk_StatusStackId = 0,
    StackDate        = GETDATE(),
    Exception        = '',
    AlertType        = temp.AlertType
FROM OVFR_COL..StackAd DESTINO
         INNER JOIN (
            SELECT A.Pk_Id AS Fk_AdId, 2 AS AlertType
            FROM OVFR_COL..Project P (NOLOCK)
                INNER JOIN OVFR_COL..Ad A ON A.Pk_Id = P.Pk_Id
            WHERE A.Fk_LocalizationLevel4Id IN (7200101,7200102,7200103,7200104,7200105,7200106,7200107,7200108,7200109,7200110,7200111,7200112,7200113) 
                AND A.Fk_LocalizationLevel5Id IN (7201001,7201002,7201003,7201004,7201005,7201006,7201007,7201008,7201009,7201010,7201011,7201012,7201013,7201014,7201015,7201016,7201017,7201018,7201019,7201020,7201021,7201022,7201023,7201024,7201025,7201026,7201027,7201028,7201029,7201030,7201031,7201032,7201033,7201034,7201035,7201036,7201037,7201038,7201039,7201040,7201041,7201042,7201043,7201044,7201045,7201046,7201047,7201048,7201049,7201050,7201051,7201052,7201053,7201054,7201055,7201056,7201057,7201058,7201059,7201060,7201061,7201062,7201063,7201064,7201065,7201066,7201067,7201068,7201069,7201070,7201071,7201072,7201073,7201074,7201075,7201076,7201077,7201078,7201079,7201080,7201081,7201082,7201083,7201084,7201085,7201086,7201087,7201088,7201089,7201090,7201091,7201092,7201093,7201094,7201095,7201096,7201097,7201098,7201099,7201100,7201101,7201102,7201103,7201104,7201105,7201106,7201107,7201108,7201109,7201110,7201111,7201112,7201113,7201114,7201115,7201116,7201117,7201118,7201119,7201120,7201121,7201122,7201123,7201124,7201125,7201126,7201127,7201128,7201129,7201130,7201131,7201132,7201133,7201134,7201135,7201136,7201137,7201138,7201139,7201140,7201141,7201142,7201143,7201144,7201145,7201146,7201147,7201148,7201149,7201150,7201151,7201152,7201153,7201154,7201155,7201156,7201157,7201158,7201159,7201160,7201161,7201162,7201163,7201164,7201165,7201166,7201167,7201168,7201169,7201170,7201171,7201172,7201173,7201174,7201175,7201176,7201177,7201178,7201179,7201180,7201181,7201182,7201183,7201184,7201185,7201186,7201187,7201188,7201189,7201190,7201191,7201192,7201193,7201194,7201195,7201196,7201197,7201198,7201199,7201200,7201201,7201202,7201203,7201204,7201205,7201206,7201207,7201208,7201209,7201210,7201211,7201212,7201213,7201214,7201215,7201216,7201217,7201218,7201219,7201220,7201221,7201222,7201223,7201224,7201225,7201226,7201227,7201228,7201229,7201230,7201231,7201232,7201233,7201234,7201235,7201236,7201237,7201238,7201239,7201240,7201241,7201242,7201243,7201244,7201245,7201246,7201247,7201248,7201249,7201250,7201251,7201252,7201253,7201254,7201255,7201256,7201257,7201258,7201259,7201260,7201261,7201262,7201263,7201264,7201265,7201266,7201267,7201268,7201269,7201270,7201271,7201272,7201273,7201274,7201275,7201276,7201277,7201278,7201279,7201280,7201281,7201282,7201283,7201284,7201285,7201286,7201287,7201288,7201289,7201290,7201291,7201292,7201293,7201294,7201295,7201296,7201297,7201298,7201299,7201300,7201301,7201302,7201303,7201304,7201305,7201306,7201307,7201308,7201309,7201310,7201311,7201312,7201313,7201314,7201315,7201316,7201317,7201318,7201319,7201320,7201321,7201322,7201323,7201324,7201325,7201326,7201327,7201328,7201329,7201330,7201331,7201332,7201333,7201334,7201335,7201336,7201337,7201338,7201339,7201340,7201341,7201342,7201343,7201344,7201345,7201346,7201347,7201348,7201349,7201350,7201351,7201352,7201353,7201354,7201355,7201356,7201357,7201358,7201359,7201360,7201361,7201362,7201363,7201364,7201365,7201366,7201367,7201368,7201369,7201370,7201371,7201372,7201373,7201374,7201375,7201376,7201377,7201378,7201379,7201380,7201381,7201382,7201383,7201384)
                AND A.Fk_StatusId = 2
) AS TEMP ON TEMP.Fk_AdId = DESTINO.Fk_AdId 
            AND TEMP.AlertType = DESTINO.AlertType

-- Tipologías

UPDATE DESTINO
SET Attempts         = 0,
    Fk_StatusStackId = 0,
    StackDate        = GETDATE(),
    Exception        = '',
    AlertType        = temp.AlertType
FROM OVFR_COL..StackAd DESTINO
         INNER JOIN (
            SELECT A.Pk_Id AS Fk_AdId, 2 as AlertType
            FROM OVFR_COL..Project P (NOLOCK)
                INNER JOIN OVFR_COL..Ad A ON A.Pk_Id = P.Pk_Id
                INNER JOIN OVFR_COL..UnitType U ON U.Fk_IdProject = A.Pk_Id 
            WHERE A.Fk_LocalizationLevel4Id IN (7200101,7200102,7200103,7200104,7200105,7200106,7200107,7200108,7200109,7200110,7200111,7200112,7200113)
                AND A.Fk_LocalizationLevel5Id IN (7201001,7201002,7201003,7201004,7201005,7201006,7201007,7201008,7201009,7201010,7201011,7201012,7201013,7201014,7201015,7201016,7201017,7201018,7201019,7201020,7201021,7201022,7201023,7201024,7201025,7201026,7201027,7201028,7201029,7201030,7201031,7201032,7201033,7201034,7201035,7201036,7201037,7201038,7201039,7201040,7201041,7201042,7201043,7201044,7201045,7201046,7201047,7201048,7201049,7201050,7201051,7201052,7201053,7201054,7201055,7201056,7201057,7201058,7201059,7201060,7201061,7201062,7201063,7201064,7201065,7201066,7201067,7201068,7201069,7201070,7201071,7201072,7201073,7201074,7201075,7201076,7201077,7201078,7201079,7201080,7201081,7201082,7201083,7201084,7201085,7201086,7201087,7201088,7201089,7201090,7201091,7201092,7201093,7201094,7201095,7201096,7201097,7201098,7201099,7201100,7201101,7201102,7201103,7201104,7201105,7201106,7201107,7201108,7201109,7201110,7201111,7201112,7201113,7201114,7201115,7201116,7201117,7201118,7201119,7201120,7201121,7201122,7201123,7201124,7201125,7201126,7201127,7201128,7201129,7201130,7201131,7201132,7201133,7201134,7201135,7201136,7201137,7201138,7201139,7201140,7201141,7201142,7201143,7201144,7201145,7201146,7201147,7201148,7201149,7201150,7201151,7201152,7201153,7201154,7201155,7201156,7201157,7201158,7201159,7201160,7201161,7201162,7201163,7201164,7201165,7201166,7201167,7201168,7201169,7201170,7201171,7201172,7201173,7201174,7201175,7201176,7201177,7201178,7201179,7201180,7201181,7201182,7201183,7201184,7201185,7201186,7201187,7201188,7201189,7201190,7201191,7201192,7201193,7201194,7201195,7201196,7201197,7201198,7201199,7201200,7201201,7201202,7201203,7201204,7201205,7201206,7201207,7201208,7201209,7201210,7201211,7201212,7201213,7201214,7201215,7201216,7201217,7201218,7201219,7201220,7201221,7201222,7201223,7201224,7201225,7201226,7201227,7201228,7201229,7201230,7201231,7201232,7201233,7201234,7201235,7201236,7201237,7201238,7201239,7201240,7201241,7201242,7201243,7201244,7201245,7201246,7201247,7201248,7201249,7201250,7201251,7201252,7201253,7201254,7201255,7201256,7201257,7201258,7201259,7201260,7201261,7201262,7201263,7201264,7201265,7201266,7201267,7201268,7201269,7201270,7201271,7201272,7201273,7201274,7201275,7201276,7201277,7201278,7201279,7201280,7201281,7201282,7201283,7201284,7201285,7201286,7201287,7201288,7201289,7201290,7201291,7201292,7201293,7201294,7201295,7201296,7201297,7201298,7201299,7201300,7201301,7201302,7201303,7201304,7201305,7201306,7201307,7201308,7201309,7201310,7201311,7201312,7201313,7201314,7201315,7201316,7201317,7201318,7201319,7201320,7201321,7201322,7201323,7201324,7201325,7201326,7201327,7201328,7201329,7201330,7201331,7201332,7201333,7201334,7201335,7201336,7201337,7201338,7201339,7201340,7201341,7201342,7201343,7201344,7201345,7201346,7201347,7201348,7201349,7201350,7201351,7201352,7201353,7201354,7201355,7201356,7201357,7201358,7201359,7201360,7201361,7201362,7201363,7201364,7201365,7201366,7201367,7201368,7201369,7201370,7201371,7201372,7201373,7201374,7201375,7201376,7201377,7201378,7201379,7201380,7201381,7201382,7201383,7201384)
                AND A.Fk_StatusId = 2
                AND U.Fk_IdProject <> 0
) AS TEMP ON TEMP.Fk_AdId = DESTINO.Fk_AdId 
            AND TEMP.AlertType = DESTINO.AlertType

---------------------------------
-- INSERT: OVFR_COL: AdvertsStack
---------------------------------

-- Inmobiliarias
INSERT INTO OVFR_COL..StackAd
SELECT TEMP.Pk_Id       AS      Fk_AdId,
       0                AS      Fk_UnitTypeId,
       2                AS      Fk_StatusStackId,
       GETDATE()        AS      StackDate,
       0                AS      Attempts,
       NULL             AS      Exception,
       TEMP.AlertType   AS      AlertType,
       NULL             AS      ReprocessedAfterError
FROM ( 
    SELECT A.Pk_Id AS Pk_Id, 1 AS AlertType
        FROM OVFR_COL..Inmo I (NOLOCK)
            INNER JOIN OVFR_COL..Ad A ON A.Pk_Id = I.Pk_Id
            LEFT JOIN OVFR_COL..StackAd S ON S.Fk_AdId = I.Pk_Id
        WHERE A.Fk_LocalizationLevel4Id IN (7200101,7200102,7200103,7200104,7200105,7200106,7200107,7200108,7200109,7200110,7200111,7200112,7200113)
            AND A.Fk_LocalizationLevel5Id IN (7201001,7201002,7201003,7201004,7201005,7201006,7201007,7201008,7201009,7201010,7201011,7201012,7201013,7201014,7201015,7201016,7201017,7201018,7201019,7201020,7201021,7201022,7201023,7201024,7201025,7201026,7201027,7201028,7201029,7201030,7201031,7201032,7201033,7201034,7201035,7201036,7201037,7201038,7201039,7201040,7201041,7201042,7201043,7201044,7201045,7201046,7201047,7201048,7201049,7201050,7201051,7201052,7201053,7201054,7201055,7201056,7201057,7201058,7201059,7201060,7201061,7201062,7201063,7201064,7201065,7201066,7201067,7201068,7201069,7201070,7201071,7201072,7201073,7201074,7201075,7201076,7201077,7201078,7201079,7201080,7201081,7201082,7201083,7201084,7201085,7201086,7201087,7201088,7201089,7201090,7201091,7201092,7201093,7201094,7201095,7201096,7201097,7201098,7201099,7201100,7201101,7201102,7201103,7201104,7201105,7201106,7201107,7201108,7201109,7201110,7201111,7201112,7201113,7201114,7201115,7201116,7201117,7201118,7201119,7201120,7201121,7201122,7201123,7201124,7201125,7201126,7201127,7201128,7201129,7201130,7201131,7201132,7201133,7201134,7201135,7201136,7201137,7201138,7201139,7201140,7201141,7201142,7201143,7201144,7201145,7201146,7201147,7201148,7201149,7201150,7201151,7201152,7201153,7201154,7201155,7201156,7201157,7201158,7201159,7201160,7201161,7201162,7201163,7201164,7201165,7201166,7201167,7201168,7201169,7201170,7201171,7201172,7201173,7201174,7201175,7201176,7201177,7201178,7201179,7201180,7201181,7201182,7201183,7201184,7201185,7201186,7201187,7201188,7201189,7201190,7201191,7201192,7201193,7201194,7201195,7201196,7201197,7201198,7201199,7201200,7201201,7201202,7201203,7201204,7201205,7201206,7201207,7201208,7201209,7201210,7201211,7201212,7201213,7201214,7201215,7201216,7201217,7201218,7201219,7201220,7201221,7201222,7201223,7201224,7201225,7201226,7201227,7201228,7201229,7201230,7201231,7201232,7201233,7201234,7201235,7201236,7201237,7201238,7201239,7201240,7201241,7201242,7201243,7201244,7201245,7201246,7201247,7201248,7201249,7201250,7201251,7201252,7201253,7201254,7201255,7201256,7201257,7201258,7201259,7201260,7201261,7201262,7201263,7201264,7201265,7201266,7201267,7201268,7201269,7201270,7201271,7201272,7201273,7201274,7201275,7201276,7201277,7201278,7201279,7201280,7201281,7201282,7201283,7201284,7201285,7201286,7201287,7201288,7201289,7201290,7201291,7201292,7201293,7201294,7201295,7201296,7201297,7201298,7201299,7201300,7201301,7201302,7201303,7201304,7201305,7201306,7201307,7201308,7201309,7201310,7201311,7201312,7201313,7201314,7201315,7201316,7201317,7201318,7201319,7201320,7201321,7201322,7201323,7201324,7201325,7201326,7201327,7201328,7201329,7201330,7201331,7201332,7201333,7201334,7201335,7201336,7201337,7201338,7201339,7201340,7201341,7201342,7201343,7201344,7201345,7201346,7201347,7201348,7201349,7201350,7201351,7201352,7201353,7201354,7201355,7201356,7201357,7201358,7201359,7201360,7201361,7201362,7201363,7201364,7201365,7201366,7201367,7201368,7201369,7201370,7201371,7201372,7201373,7201374,7201375,7201376,7201377,7201378,7201379,7201380,7201381,7201382,7201383,7201384)
            AND S.Fk_AdId IS NULL
            AND A.Fk_StatusId = 2
    ) AS TEMP

-- Proyectos

INSERT INTO OVFR_COL..StackAd
SELECT TEMP.Pk_Id       AS      Fk_AdId,
       0                AS      Fk_UnitTypeId,
       2                AS      Fk_StatusStackId,
       GETDATE()        AS      StackDate,
       0                AS      Attempts,
       NULL             AS      Exception,
       TEMP.AlertType   AS      AlertType,
       NULL             AS      ReprocessedAfterError
FROM (
    SELECT A.Pk_Id AS Pk_Id, 2 AS AlertType
    FROM OVFR_COL..Project P (NOLOCK)
        INNER JOIN OVFR_COL..Ad A ON A.Pk_Id = P.Pk_Id
        LEFT JOIN OVFR_COL..StackAd S ON S.Fk_AdId = A.Pk_Id
    WHERE A.Fk_LocalizationLevel4Id IN (7200101,7200102,7200103,7200104,7200105,7200106,7200107,7200108,7200109,7200110,7200111,7200112,7200113)
        AND A.Fk_LocalizationLevel5Id IN (7201001,7201002,7201003,7201004,7201005,7201006,7201007,7201008,7201009,7201010,7201011,7201012,7201013,7201014,7201015,7201016,7201017,7201018,7201019,7201020,7201021,7201022,7201023,7201024,7201025,7201026,7201027,7201028,7201029,7201030,7201031,7201032,7201033,7201034,7201035,7201036,7201037,7201038,7201039,7201040,7201041,7201042,7201043,7201044,7201045,7201046,7201047,7201048,7201049,7201050,7201051,7201052,7201053,7201054,7201055,7201056,7201057,7201058,7201059,7201060,7201061,7201062,7201063,7201064,7201065,7201066,7201067,7201068,7201069,7201070,7201071,7201072,7201073,7201074,7201075,7201076,7201077,7201078,7201079,7201080,7201081,7201082,7201083,7201084,7201085,7201086,7201087,7201088,7201089,7201090,7201091,7201092,7201093,7201094,7201095,7201096,7201097,7201098,7201099,7201100,7201101,7201102,7201103,7201104,7201105,7201106,7201107,7201108,7201109,7201110,7201111,7201112,7201113,7201114,7201115,7201116,7201117,7201118,7201119,7201120,7201121,7201122,7201123,7201124,7201125,7201126,7201127,7201128,7201129,7201130,7201131,7201132,7201133,7201134,7201135,7201136,7201137,7201138,7201139,7201140,7201141,7201142,7201143,7201144,7201145,7201146,7201147,7201148,7201149,7201150,7201151,7201152,7201153,7201154,7201155,7201156,7201157,7201158,7201159,7201160,7201161,7201162,7201163,7201164,7201165,7201166,7201167,7201168,7201169,7201170,7201171,7201172,7201173,7201174,7201175,7201176,7201177,7201178,7201179,7201180,7201181,7201182,7201183,7201184,7201185,7201186,7201187,7201188,7201189,7201190,7201191,7201192,7201193,7201194,7201195,7201196,7201197,7201198,7201199,7201200,7201201,7201202,7201203,7201204,7201205,7201206,7201207,7201208,7201209,7201210,7201211,7201212,7201213,7201214,7201215,7201216,7201217,7201218,7201219,7201220,7201221,7201222,7201223,7201224,7201225,7201226,7201227,7201228,7201229,7201230,7201231,7201232,7201233,7201234,7201235,7201236,7201237,7201238,7201239,7201240,7201241,7201242,7201243,7201244,7201245,7201246,7201247,7201248,7201249,7201250,7201251,7201252,7201253,7201254,7201255,7201256,7201257,7201258,7201259,7201260,7201261,7201262,7201263,7201264,7201265,7201266,7201267,7201268,7201269,7201270,7201271,7201272,7201273,7201274,7201275,7201276,7201277,7201278,7201279,7201280,7201281,7201282,7201283,7201284,7201285,7201286,7201287,7201288,7201289,7201290,7201291,7201292,7201293,7201294,7201295,7201296,7201297,7201298,7201299,7201300,7201301,7201302,7201303,7201304,7201305,7201306,7201307,7201308,7201309,7201310,7201311,7201312,7201313,7201314,7201315,7201316,7201317,7201318,7201319,7201320,7201321,7201322,7201323,7201324,7201325,7201326,7201327,7201328,7201329,7201330,7201331,7201332,7201333,7201334,7201335,7201336,7201337,7201338,7201339,7201340,7201341,7201342,7201343,7201344,7201345,7201346,7201347,7201348,7201349,7201350,7201351,7201352,7201353,7201354,7201355,7201356,7201357,7201358,7201359,7201360,7201361,7201362,7201363,7201364,7201365,7201366,7201367,7201368,7201369,7201370,7201371,7201372,7201373,7201374,7201375,7201376,7201377,7201378,7201379,7201380,7201381,7201382,7201383,7201384)
        AND S.Fk_AdId IS NULL
        AND A.Fk_StatusId = 2
    ) AS TEMP

-- Tipologías

INSERT INTO OVFR_COL..StackAd
SELECT TEMP.Pk_AdId         AS      Fk_AdId,
       TEMP.Fk_UnitTypeId   AS      Fk_UnitTypeId,
       2                    AS      Fk_StatusStackId,
       GETDATE()            AS      StackDate,
       0                    AS      Attempts,
       NULL                 AS      Exception,
       TEMP.AlertType       AS      AlertType,
       NULL                 AS      ReprocessedAfterError
FROM 
      (
        SELECT A.Pk_Id AS Pk_AdId, U.Pk_Id Fk_UnitTypeId, 2 as AlertType
        FROM OVFR_COL..Ad A (NOLOCK)
            INNER JOIN OVFR_COL..Project P ON A.Pk_Id = P.Pk_Id
            INNER JOIN OVFR_COL..UnitType U ON U.Fk_IdProject = A.Pk_Id
            LEFT JOIN OVFR_COL..StackAd S ON S.Fk_AdId = A.Pk_Id AND S.Fk_UnitTypeId = U.Pk_Id
            WHERE A.Fk_LocalizationLevel4Id IN (7200101,7200102,7200103,7200104,7200105,7200106,7200107,7200108,7200109,7200110,7200111,7200112,7200113) 
                AND A.Fk_LocalizationLevel5Id IN (7201001,7201002,7201003,7201004,7201005,7201006,7201007,7201008,7201009,7201010,7201011,7201012,7201013,7201014,7201015,7201016,7201017,7201018,7201019,7201020,7201021,7201022,7201023,7201024,7201025,7201026,7201027,7201028,7201029,7201030,7201031,7201032,7201033,7201034,7201035,7201036,7201037,7201038,7201039,7201040,7201041,7201042,7201043,7201044,7201045,7201046,7201047,7201048,7201049,7201050,7201051,7201052,7201053,7201054,7201055,7201056,7201057,7201058,7201059,7201060,7201061,7201062,7201063,7201064,7201065,7201066,7201067,7201068,7201069,7201070,7201071,7201072,7201073,7201074,7201075,7201076,7201077,7201078,7201079,7201080,7201081,7201082,7201083,7201084,7201085,7201086,7201087,7201088,7201089,7201090,7201091,7201092,7201093,7201094,7201095,7201096,7201097,7201098,7201099,7201100,7201101,7201102,7201103,7201104,7201105,7201106,7201107,7201108,7201109,7201110,7201111,7201112,7201113,7201114,7201115,7201116,7201117,7201118,7201119,7201120,7201121,7201122,7201123,7201124,7201125,7201126,7201127,7201128,7201129,7201130,7201131,7201132,7201133,7201134,7201135,7201136,7201137,7201138,7201139,7201140,7201141,7201142,7201143,7201144,7201145,7201146,7201147,7201148,7201149,7201150,7201151,7201152,7201153,7201154,7201155,7201156,7201157,7201158,7201159,7201160,7201161,7201162,7201163,7201164,7201165,7201166,7201167,7201168,7201169,7201170,7201171,7201172,7201173,7201174,7201175,7201176,7201177,7201178,7201179,7201180,7201181,7201182,7201183,7201184,7201185,7201186,7201187,7201188,7201189,7201190,7201191,7201192,7201193,7201194,7201195,7201196,7201197,7201198,7201199,7201200,7201201,7201202,7201203,7201204,7201205,7201206,7201207,7201208,7201209,7201210,7201211,7201212,7201213,7201214,7201215,7201216,7201217,7201218,7201219,7201220,7201221,7201222,7201223,7201224,7201225,7201226,7201227,7201228,7201229,7201230,7201231,7201232,7201233,7201234,7201235,7201236,7201237,7201238,7201239,7201240,7201241,7201242,7201243,7201244,7201245,7201246,7201247,7201248,7201249,7201250,7201251,7201252,7201253,7201254,7201255,7201256,7201257,7201258,7201259,7201260,7201261,7201262,7201263,7201264,7201265,7201266,7201267,7201268,7201269,7201270,7201271,7201272,7201273,7201274,7201275,7201276,7201277,7201278,7201279,7201280,7201281,7201282,7201283,7201284,7201285,7201286,7201287,7201288,7201289,7201290,7201291,7201292,7201293,7201294,7201295,7201296,7201297,7201298,7201299,7201300,7201301,7201302,7201303,7201304,7201305,7201306,7201307,7201308,7201309,7201310,7201311,7201312,7201313,7201314,7201315,7201316,7201317,7201318,7201319,7201320,7201321,7201322,7201323,7201324,7201325,7201326,7201327,7201328,7201329,7201330,7201331,7201332,7201333,7201334,7201335,7201336,7201337,7201338,7201339,7201340,7201341,7201342,7201343,7201344,7201345,7201346,7201347,7201348,7201349,7201350,7201351,7201352,7201353,7201354,7201355,7201356,7201357,7201358,7201359,7201360,7201361,7201362,7201363,7201364,7201365,7201366,7201367,7201368,7201369,7201370,7201371,7201372,7201373,7201374,7201375,7201376,7201377,7201378,7201379,7201380,7201381,7201382,7201383,7201384)
                AND S.Fk_AdId Is NULL
                AND A.Fk_StatusId = 2
        ) AS TEMP
    

--------------------------
--------------------------
--FC Stack Update & Insert
--------------------------
--------------------------

-- Update

UPDATE Destino
SET [Date] = GETDATE(),
    [Priority] = 0,
    [Attempts] = 0,
    [Status] = 0 
FROM FC_COL_AUX..AdvertsStack Destino
    INNER JOIN (
        SELECT MAX(S.PK_AdvertsStackId) PK_AdvertsStackId, S.AdvertId
        FROM FC_COL_AUX..AdvertsStack S
            INNER JOIN FC_COL_WRT..AdvertsRealstate R ON S.AdvertId = R.PK_AdvertId
            INNER JOIN FC_COL_WRT..Adverts A ON R.PK_AdvertId = A.PK_AdvertId
        WHERE R.Fk_Location3Id IN (7200101,7200102,7200103,7200104,7200105,7200106,7200107,7200108,7200109,7200110,7200111,7200112,7200113)
            AND R.FK_Location4Id IN (7201001,7201002,7201003,7201004,7201005,7201006,7201007,7201008,7201009,7201010,7201011,7201012,7201013,7201014,7201015,7201016,7201017,7201018,7201019,7201020,7201021,7201022,7201023,7201024,7201025,7201026,7201027,7201028,7201029,7201030,7201031,7201032,7201033,7201034,7201035,7201036,7201037,7201038,7201039,7201040,7201041,7201042,7201043,7201044,7201045,7201046,7201047,7201048,7201049,7201050,7201051,7201052,7201053,7201054,7201055,7201056,7201057,7201058,7201059,7201060,7201061,7201062,7201063,7201064,7201065,7201066,7201067,7201068,7201069,7201070,7201071,7201072,7201073,7201074,7201075,7201076,7201077,7201078,7201079,7201080,7201081,7201082,7201083,7201084,7201085,7201086,7201087,7201088,7201089,7201090,7201091,7201092,7201093,7201094,7201095,7201096,7201097,7201098,7201099,7201100,7201101,7201102,7201103,7201104,7201105,7201106,7201107,7201108,7201109,7201110,7201111,7201112,7201113,7201114,7201115,7201116,7201117,7201118,7201119,7201120,7201121,7201122,7201123,7201124,7201125,7201126,7201127,7201128,7201129,7201130,7201131,7201132,7201133,7201134,7201135,7201136,7201137,7201138,7201139,7201140,7201141,7201142,7201143,7201144,7201145,7201146,7201147,7201148,7201149,7201150,7201151,7201152,7201153,7201154,7201155,7201156,7201157,7201158,7201159,7201160,7201161,7201162,7201163,7201164,7201165,7201166,7201167,7201168,7201169,7201170,7201171,7201172,7201173,7201174,7201175,7201176,7201177,7201178,7201179,7201180,7201181,7201182,7201183,7201184,7201185,7201186,7201187,7201188,7201189,7201190,7201191,7201192,7201193,7201194,7201195,7201196,7201197,7201198,7201199,7201200,7201201,7201202,7201203,7201204,7201205,7201206,7201207,7201208,7201209,7201210,7201211,7201212,7201213,7201214,7201215,7201216,7201217,7201218,7201219,7201220,7201221,7201222,7201223,7201224,7201225,7201226,7201227,7201228,7201229,7201230,7201231,7201232,7201233,7201234,7201235,7201236,7201237,7201238,7201239,7201240,7201241,7201242,7201243,7201244,7201245,7201246,7201247,7201248,7201249,7201250,7201251,7201252,7201253,7201254,7201255,7201256,7201257,7201258,7201259,7201260,7201261,7201262,7201263,7201264,7201265,7201266,7201267,7201268,7201269,7201270,7201271,7201272,7201273,7201274,7201275,7201276,7201277,7201278,7201279,7201280,7201281,7201282,7201283,7201284,7201285,7201286,7201287,7201288,7201289,7201290,7201291,7201292,7201293,7201294,7201295,7201296,7201297,7201298,7201299,7201300,7201301,7201302,7201303,7201304,7201305,7201306,7201307,7201308,7201309,7201310,7201311,7201312,7201313,7201314,7201315,7201316,7201317,7201318,7201319,7201320,7201321,7201322,7201323,7201324,7201325,7201326,7201327,7201328,7201329,7201330,7201331,7201332,7201333,7201334,7201335,7201336,7201337,7201338,7201339,7201340,7201341,7201342,7201343,7201344,7201345,7201346,7201347,7201348,7201349,7201350,7201351,7201352,7201353,7201354,7201355,7201356,7201357,7201358,7201359,7201360,7201361,7201362,7201363,7201364,7201365,7201366,7201367,7201368,7201369,7201370,7201371,7201372,7201373,7201374,7201375,7201376,7201377,7201378,7201379,7201380,7201381,7201382,7201383,7201384)
            AND A.[Status] = 2
        GROUP BY S.AdvertId
    ) AS TEMP ON TEMP.PK_AdvertsStackId = Destino.PK_AdvertsStackId

-- Insert

INSERT INTO FC_COL_AUX..AdvertsStack
SELECT  R.PK_AdvertId   AS  AdvertId, 
        2               AS  AdvertCategoryId,
        A.FK_ClientId   AS  ClientId,
        GETDATE()       AS  [Date],
        0               AS  Priority,
        0               AS  Attempts,
        0               AS  [Status]
FROM FC_COL_AUX..AdvertsStack S (NOLOCK)
    RIGHT JOIN FC_COL_WRT..AdvertsRealstate R ON S.AdvertId = R.PK_AdvertId
    INNER JOIN FC_COL_WRT..Adverts A ON R.PK_AdvertId = A.PK_AdvertId
WHERE R.Fk_Location3Id IN (7200101,7200102,7200103,7200104,7200105,7200106,7200107,7200108,7200109,7200110,7200111,7200112,7200113) 
    AND FK_Location4Id IN (7201001,7201002,7201003,7201004,7201005,7201006,7201007,7201008,7201009,7201010,7201011,7201012,7201013,7201014,7201015,7201016,7201017,7201018,7201019,7201020,7201021,7201022,7201023,7201024,7201025,7201026,7201027,7201028,7201029,7201030,7201031,7201032,7201033,7201034,7201035,7201036,7201037,7201038,7201039,7201040,7201041,7201042,7201043,7201044,7201045,7201046,7201047,7201048,7201049,7201050,7201051,7201052,7201053,7201054,7201055,7201056,7201057,7201058,7201059,7201060,7201061,7201062,7201063,7201064,7201065,7201066,7201067,7201068,7201069,7201070,7201071,7201072,7201073,7201074,7201075,7201076,7201077,7201078,7201079,7201080,7201081,7201082,7201083,7201084,7201085,7201086,7201087,7201088,7201089,7201090,7201091,7201092,7201093,7201094,7201095,7201096,7201097,7201098,7201099,7201100,7201101,7201102,7201103,7201104,7201105,7201106,7201107,7201108,7201109,7201110,7201111,7201112,7201113,7201114,7201115,7201116,7201117,7201118,7201119,7201120,7201121,7201122,7201123,7201124,7201125,7201126,7201127,7201128,7201129,7201130,7201131,7201132,7201133,7201134,7201135,7201136,7201137,7201138,7201139,7201140,7201141,7201142,7201143,7201144,7201145,7201146,7201147,7201148,7201149,7201150,7201151,7201152,7201153,7201154,7201155,7201156,7201157,7201158,7201159,7201160,7201161,7201162,7201163,7201164,7201165,7201166,7201167,7201168,7201169,7201170,7201171,7201172,7201173,7201174,7201175,7201176,7201177,7201178,7201179,7201180,7201181,7201182,7201183,7201184,7201185,7201186,7201187,7201188,7201189,7201190,7201191,7201192,7201193,7201194,7201195,7201196,7201197,7201198,7201199,7201200,7201201,7201202,7201203,7201204,7201205,7201206,7201207,7201208,7201209,7201210,7201211,7201212,7201213,7201214,7201215,7201216,7201217,7201218,7201219,7201220,7201221,7201222,7201223,7201224,7201225,7201226,7201227,7201228,7201229,7201230,7201231,7201232,7201233,7201234,7201235,7201236,7201237,7201238,7201239,7201240,7201241,7201242,7201243,7201244,7201245,7201246,7201247,7201248,7201249,7201250,7201251,7201252,7201253,7201254,7201255,7201256,7201257,7201258,7201259,7201260,7201261,7201262,7201263,7201264,7201265,7201266,7201267,7201268,7201269,7201270,7201271,7201272,7201273,7201274,7201275,7201276,7201277,7201278,7201279,7201280,7201281,7201282,7201283,7201284,7201285,7201286,7201287,7201288,7201289,7201290,7201291,7201292,7201293,7201294,7201295,7201296,7201297,7201298,7201299,7201300,7201301,7201302,7201303,7201304,7201305,7201306,7201307,7201308,7201309,7201310,7201311,7201312,7201313,7201314,7201315,7201316,7201317,7201318,7201319,7201320,7201321,7201322,7201323,7201324,7201325,7201326,7201327,7201328,7201329,7201330,7201331,7201332,7201333,7201334,7201335,7201336,7201337,7201338,7201339,7201340,7201341,7201342,7201343,7201344,7201345,7201346,7201347,7201348,7201349,7201350,7201351,7201352,7201353,7201354,7201355,7201356,7201357,7201358,7201359,7201360,7201361,7201362,7201363,7201364,7201365,7201366,7201367,7201368,7201369,7201370,7201371,7201372,7201373,7201374,7201375,7201376,7201377,7201378,7201379,7201380,7201381,7201382,7201383,7201384)
    AND S.AdvertId IS NULL
    AND A.[Status] = 2
