
---------------------------------
-- UPDATE: OVFR_COL: AdvertsStack 
---------------------------------

-- Inmobiliarias

UPDATE DESTINO
SET Attempts         = 0,
    Fk_StatusStackId = 0,
    StackDate        = GETDATE(),
    Exception        = '',
    AlertType        = temp.AlertType
--SELECT *
FROM OVFR_COL..StackAd DESTINO
         INNER JOIN (
            SELECT A.Pk_Id AS Fk_AdId, 1 AS AlertType
            FROM OVFR_COL..Inmo I (NOLOCK)
                INNER JOIN OVFR_COL..Ad A (NOLOCK) ON A.Pk_Id = I.Pk_Id AND A.Fk_StatusId = 2
            WHERE A.Fk_LocalizationLevel4Id IN (7500101,7500102,7500103,7500104,7500105,7500106,7500107,7500108,7500109,7500110,7500111,7500112,7500113,7500114,7500115,7500116,7500117)
                AND A.Fk_LocalizationLevel5Id IN (7501001,7501002,7501005,7501007,7501008,7501009,7501010,7501011,7501012,7501013,7501014,7501015,7501016,7501017,7501018,7501019,7501020,7501021,7501022,7501023,7501024,7501025,7501026,7501027,7501028,7501029,7501030,7501031,7501032,7501033,7501034,7501035,7501036,7501037,7501038,7501039,7501040,7501041,7501042,7501043,7501045,7501047,7501053,7501054,7501057,7501059,7501060,7501061,7501062,7501063,7501064,7501065,7501066,7501067,7501068,7501069,7501070,7501071,7501072,7501073,7501074,7501075,7501078,7501079,7501080,7501081,7501082,7501083,7501084,7501085,7501086,7501087,7501089,7501090,7501091,7501097,7501099,7501100,7501102,7501103,7501104,7501105,7501106,7501107,7501108,7501109,7501110,7501111,7501112,7501113,7501114,7501115,7501116,7501117,7501118,7501119,7501120,7501121,7501122,7501123,7501125,7501127,7501128,7501129,7501130,7501134,7501136,7501137,7501138,7501139,7501140,7501142,7501143,7501144,7501145,7501146,7501147,7501149,7501150,7501153,7501158,7501161,7501162,7501170,7501176,7501177,7501178,7501179,7501180,7501181,7501182,7501183,7501184,7501185,7501190,7501191,7501192,7501193,7501194,7501195,7501196,7501197,7501198,7501199,7501200,7501201,7501202)
) AS TEMP ON TEMP.Fk_AdId = DESTINO.Fk_AdId 
            AND TEMP.AlertType = DESTINO.AlertType

-- Proyectos

UPDATE DESTINO
SET Attempts         = 0,
    Fk_StatusStackId = 0,
    StackDate        = GETDATE(),
    Exception        = '',
    AlertType        = temp.AlertType
FROM OVFR_COL..StackAd DESTINO
         INNER JOIN (
            SELECT A.Pk_Id AS Fk_AdId, 2 AS AlertType
            FROM OVFR_COL..Project P
                INNER JOIN OVFR_COL..Ad A ON A.Pk_Id = P.Pk_Id
            WHERE A.Fk_LocalizationLevel4Id IN (7500101,7500102,7500103,7500104,7500105,7500106,7500107,7500108,7500109,7500110,7500111,7500112,7500113,7500114,7500115,7500116,7500117) 
                AND A.Fk_LocalizationLevel5Id IN (7501001,7501002,7501005,7501007,7501008,7501009,7501010,7501011,7501012,7501013,7501014,7501015,7501016,7501017,7501018,7501019,7501020,7501021,7501022,7501023,7501024,7501025,7501026,7501027,7501028,7501029,7501030,7501031,7501032,7501033,7501034,7501035,7501036,7501037,7501038,7501039,7501040,7501041,7501042,7501043,7501045,7501047,7501053,7501054,7501057,7501059,7501060,7501061,7501062,7501063,7501064,7501065,7501066,7501067,7501068,7501069,7501070,7501071,7501072,7501073,7501074,7501075,7501078,7501079,7501080,7501081,7501082,7501083,7501084,7501085,7501086,7501087,7501089,7501090,7501091,7501097,7501099,7501100,7501102,7501103,7501104,7501105,7501106,7501107,7501108,7501109,7501110,7501111,7501112,7501113,7501114,7501115,7501116,7501117,7501118,7501119,7501120,7501121,7501122,7501123,7501125,7501127,7501128,7501129,7501130,7501134,7501136,7501137,7501138,7501139,7501140,7501142,7501143,7501144,7501145,7501146,7501147,7501149,7501150,7501153,7501158,7501161,7501162,7501170,7501176,7501177,7501178,7501179,7501180,7501181,7501182,7501183,7501184,7501185,7501190,7501191,7501192,7501193,7501194,7501195,7501196,7501197,7501198,7501199,7501200,7501201,7501202)
                AND A.Fk_StatusId = 2
) AS TEMP ON TEMP.Fk_AdId = DESTINO.Fk_AdId 
            AND TEMP.AlertType = DESTINO.AlertType

-- Tipologías

UPDATE DESTINO
SET Attempts         = 0,
    Fk_StatusStackId = 0,
    StackDate        = GETDATE(),
    Exception        = '',
    AlertType        = temp.AlertType
FROM OVFR_COL..StackAd DESTINO
         INNER JOIN (
            SELECT A.Pk_Id AS Fk_AdId, 2 as AlertType
            FROM OVFR_COL..Project P
                INNER JOIN OVFR_COL..Ad A ON A.Pk_Id = P.Pk_Id
                INNER JOIN OVFR_COL..UnitType U ON U.Fk_IdProject = A.Pk_Id 
            WHERE A.Fk_LocalizationLevel4Id IN (7500101,7500102,7500103,7500104,7500105,7500106,7500107,7500108,7500109,7500110,7500111,7500112,7500113,7500114,7500115,7500116,7500117)
                AND A.Fk_LocalizationLevel5Id IN (7501001,7501002,7501005,7501007,7501008,7501009,7501010,7501011,7501012,7501013,7501014,7501015,7501016,7501017,7501018,7501019,7501020,7501021,7501022,7501023,7501024,7501025,7501026,7501027,7501028,7501029,7501030,7501031,7501032,7501033,7501034,7501035,7501036,7501037,7501038,7501039,7501040,7501041,7501042,7501043,7501045,7501047,7501053,7501054,7501057,7501059,7501060,7501061,7501062,7501063,7501064,7501065,7501066,7501067,7501068,7501069,7501070,7501071,7501072,7501073,7501074,7501075,7501078,7501079,7501080,7501081,7501082,7501083,7501084,7501085,7501086,7501087,7501089,7501090,7501091,7501097,7501099,7501100,7501102,7501103,7501104,7501105,7501106,7501107,7501108,7501109,7501110,7501111,7501112,7501113,7501114,7501115,7501116,7501117,7501118,7501119,7501120,7501121,7501122,7501123,7501125,7501127,7501128,7501129,7501130,7501134,7501136,7501137,7501138,7501139,7501140,7501142,7501143,7501144,7501145,7501146,7501147,7501149,7501150,7501153,7501158,7501161,7501162,7501170,7501176,7501177,7501178,7501179,7501180,7501181,7501182,7501183,7501184,7501185,7501190,7501191,7501192,7501193,7501194,7501195,7501196,7501197,7501198,7501199,7501200,7501201,7501202)
                AND A.Fk_StatusId = 2
                AND U.Fk_IdProject <> 0
) AS TEMP ON TEMP.Fk_AdId = DESTINO.Fk_AdId 
            AND TEMP.AlertType = DESTINO.AlertType

---------------------------------
-- INSERT: OVFR_COL: AdvertsStack
---------------------------------

-- Inmobiliarias
INSERT INTO OVFR_COL..StackAd
SELECT TEMP.Pk_Id       AS      Fk_AdId,
       0                AS      Fk_UnitTypeId,
       2                AS      Fk_StatusStackId,
       GETDATE()        AS      StackDate,
       0                AS      Attempts,
       NULL             AS      Exception,
       TEMP.AlertType   AS      AlertType,
       NULL             AS      ReprocessedAfterError
FROM ( 
    SELECT A.Pk_Id AS Pk_Id, 1 AS AlertType
        FROM OVFR_COL..Inmo I (NOLOCK)
            INNER JOIN OVFR_COL..Ad A ON A.Pk_Id = I.Pk_Id
            LEFT JOIN OVFR_COL..StackAd S ON S.Fk_AdId = I.Pk_Id
        WHERE A.Fk_LocalizationLevel4Id IN (7500101,7500102,7500103,7500104,7500105,7500106,7500107,7500108,7500109,7500110,7500111,7500112,7500113,7500114,7500115,7500116,7500117)
            AND A.Fk_LocalizationLevel5Id IN (7501001,7501002,7501005,7501007,7501008,7501009,7501010,7501011,7501012,7501013,7501014,7501015,7501016,7501017,7501018,7501019,7501020,7501021,7501022,7501023,7501024,7501025,7501026,7501027,7501028,7501029,7501030,7501031,7501032,7501033,7501034,7501035,7501036,7501037,7501038,7501039,7501040,7501041,7501042,7501043,7501045,7501047,7501053,7501054,7501057,7501059,7501060,7501061,7501062,7501063,7501064,7501065,7501066,7501067,7501068,7501069,7501070,7501071,7501072,7501073,7501074,7501075,7501078,7501079,7501080,7501081,7501082,7501083,7501084,7501085,7501086,7501087,7501089,7501090,7501091,7501097,7501099,7501100,7501102,7501103,7501104,7501105,7501106,7501107,7501108,7501109,7501110,7501111,7501112,7501113,7501114,7501115,7501116,7501117,7501118,7501119,7501120,7501121,7501122,7501123,7501125,7501127,7501128,7501129,7501130,7501134,7501136,7501137,7501138,7501139,7501140,7501142,7501143,7501144,7501145,7501146,7501147,7501149,7501150,7501153,7501158,7501161,7501162,7501170,7501176,7501177,7501178,7501179,7501180,7501181,7501182,7501183,7501184,7501185,7501190,7501191,7501192,7501193,7501194,7501195,7501196,7501197,7501198,7501199,7501200,7501201,7501202)
            AND S.Fk_AdId IS NULL
            AND A.Fk_StatusId = 2
    ) AS TEMP

-- Proyectos

INSERT INTO OVFR_COL..StackAd
SELECT TEMP.Pk_Id       AS      Fk_AdId,
       0                AS      Fk_UnitTypeId,
       2                AS      Fk_StatusStackId,
       GETDATE()        AS      StackDate,
       0                AS      Attempts,
       NULL             AS      Exception,
       TEMP.AlertType   AS      AlertType,
       NULL             AS      ReprocessedAfterError
FROM (
    SELECT A.Pk_Id AS Pk_Id, 2 AS AlertType
    FROM OVFR_COL..Project P
        INNER JOIN OVFR_COL..Ad A ON A.Pk_Id = P.Pk_Id
        LEFT JOIN OVFR_COL..StackAd S ON S.Fk_AdId = A.Pk_Id
    WHERE A.Fk_LocalizationLevel4Id IN (7500101,7500102,7500103,7500104,7500105,7500106,7500107,7500108,7500109,7500110,7500111,7500112,7500113,7500114,7500115,7500116,7500117)
        AND A.Fk_LocalizationLevel5Id IN (7501001,7501002,7501005,7501007,7501008,7501009,7501010,7501011,7501012,7501013,7501014,7501015,7501016,7501017,7501018,7501019,7501020,7501021,7501022,7501023,7501024,7501025,7501026,7501027,7501028,7501029,7501030,7501031,7501032,7501033,7501034,7501035,7501036,7501037,7501038,7501039,7501040,7501041,7501042,7501043,7501045,7501047,7501053,7501054,7501057,7501059,7501060,7501061,7501062,7501063,7501064,7501065,7501066,7501067,7501068,7501069,7501070,7501071,7501072,7501073,7501074,7501075,7501078,7501079,7501080,7501081,7501082,7501083,7501084,7501085,7501086,7501087,7501089,7501090,7501091,7501097,7501099,7501100,7501102,7501103,7501104,7501105,7501106,7501107,7501108,7501109,7501110,7501111,7501112,7501113,7501114,7501115,7501116,7501117,7501118,7501119,7501120,7501121,7501122,7501123,7501125,7501127,7501128,7501129,7501130,7501134,7501136,7501137,7501138,7501139,7501140,7501142,7501143,7501144,7501145,7501146,7501147,7501149,7501150,7501153,7501158,7501161,7501162,7501170,7501176,7501177,7501178,7501179,7501180,7501181,7501182,7501183,7501184,7501185,7501190,7501191,7501192,7501193,7501194,7501195,7501196,7501197,7501198,7501199,7501200,7501201,7501202)
        AND S.Fk_AdId IS NULL
        AND A.Fk_StatusId = 2
    ) AS TEMP

-- Tipologías

INSERT INTO OVFR_COL..StackAd
SELECT TEMP.Pk_AdId         AS      Fk_AdId,
       TEMP.Fk_UnitTypeId   AS      Fk_UnitTypeId,
       2                    AS      Fk_StatusStackId,
       GETDATE()            AS      StackDate,
       0                    AS      Attempts,
       NULL                 AS      Exception,
       TEMP.AlertType       AS      AlertType,
       NULL                 AS      ReprocessedAfterError
FROM 
      (
        SELECT A.Pk_Id AS Pk_AdId, U.Pk_Id Fk_UnitTypeId, 2 as AlertType
        FROM OVFR_COL..Ad A (NOLOCK)
            INNER JOIN OVFR_COL..Project P ON A.Pk_Id = P.Pk_Id
            INNER JOIN OVFR_COL..UnitType U ON U.Fk_IdProject = A.Pk_Id
            LEFT JOIN OVFR_COL..StackAd S ON S.Fk_AdId = A.Pk_Id AND S.Fk_UnitTypeId = U.Pk_Id
            WHERE A.Fk_LocalizationLevel4Id IN (7500101,7500102,7500103,7500104,7500105,7500106,7500107,7500108,7500109,7500110,7500111,7500112,7500113,7500114,7500115,7500116,7500117) 
                AND A.Fk_LocalizationLevel5Id IN (7501001,7501002,7501005,7501007,7501008,7501009,7501010,7501011,7501012,7501013,7501014,7501015,7501016,7501017,7501018,7501019,7501020,7501021,7501022,7501023,7501024,7501025,7501026,7501027,7501028,7501029,7501030,7501031,7501032,7501033,7501034,7501035,7501036,7501037,7501038,7501039,7501040,7501041,7501042,7501043,7501045,7501047,7501053,7501054,7501057,7501059,7501060,7501061,7501062,7501063,7501064,7501065,7501066,7501067,7501068,7501069,7501070,7501071,7501072,7501073,7501074,7501075,7501078,7501079,7501080,7501081,7501082,7501083,7501084,7501085,7501086,7501087,7501089,7501090,7501091,7501097,7501099,7501100,7501102,7501103,7501104,7501105,7501106,7501107,7501108,7501109,7501110,7501111,7501112,7501113,7501114,7501115,7501116,7501117,7501118,7501119,7501120,7501121,7501122,7501123,7501125,7501127,7501128,7501129,7501130,7501134,7501136,7501137,7501138,7501139,7501140,7501142,7501143,7501144,7501145,7501146,7501147,7501149,7501150,7501153,7501158,7501161,7501162,7501170,7501176,7501177,7501178,7501179,7501180,7501181,7501182,7501183,7501184,7501185,7501190,7501191,7501192,7501193,7501194,7501195,7501196,7501197,7501198,7501199,7501200,7501201,7501202)
                AND S.Fk_AdId Is NULL
                AND A.Fk_StatusId = 2
        ) AS TEMP
    

--------------------------
--------------------------
--FC Stack Update & Insert
--------------------------
--------------------------

-- Update

UPDATE Destino
SET [Date] = GETDATE(),
    [Priority] = 0,
    [Attempts] = 0,
    [Status] = 0 
FROM FC_COL_AUX..AdvertsStack Destino
    INNER JOIN (
        SELECT MAX(S.PK_AdvertsStackId) PK_AdvertsStackId, S.AdvertId
        FROM FC_COL_AUX..AdvertsStack S
            INNER JOIN FC_COL_WRT..AdvertsRealstate R ON S.AdvertId = R.PK_AdvertId
            INNER JOIN FC_COL_WRT..Adverts A ON R.PK_AdvertId = A.PK_AdvertId
        WHERE R.Fk_Location3Id IN (7500101,7500102,7500103,7500104,7500105,7500106,7500107,7500108,7500109,7500110,7500111,7500112,7500113,7500114,7500115,7500116,7500117)
            AND R.FK_Location4Id IN (7501001,7501002,7501005,7501007,7501008,7501009,7501010,7501011,7501012,7501013,7501014,7501015,7501016,7501017,7501018,7501019,7501020,7501021,7501022,7501023,7501024,7501025,7501026,7501027,7501028,7501029,7501030,7501031,7501032,7501033,7501034,7501035,7501036,7501037,7501038,7501039,7501040,7501041,7501042,7501043,7501045,7501047,7501053,7501054,7501057,7501059,7501060,7501061,7501062,7501063,7501064,7501065,7501066,7501067,7501068,7501069,7501070,7501071,7501072,7501073,7501074,7501075,7501078,7501079,7501080,7501081,7501082,7501083,7501084,7501085,7501086,7501087,7501089,7501090,7501091,7501097,7501099,7501100,7501102,7501103,7501104,7501105,7501106,7501107,7501108,7501109,7501110,7501111,7501112,7501113,7501114,7501115,7501116,7501117,7501118,7501119,7501120,7501121,7501122,7501123,7501125,7501127,7501128,7501129,7501130,7501134,7501136,7501137,7501138,7501139,7501140,7501142,7501143,7501144,7501145,7501146,7501147,7501149,7501150,7501153,7501158,7501161,7501162,7501170,7501176,7501177,7501178,7501179,7501180,7501181,7501182,7501183,7501184,7501185,7501190,7501191,7501192,7501193,7501194,7501195,7501196,7501197,7501198,7501199,7501200,7501201,7501202)
            AND A.[Status] = 2
        GROUP BY S.AdvertId
    ) AS TEMP ON TEMP.PK_AdvertsStackId = Destino.PK_AdvertsStackId

-- Insert

INSERT INTO FC_COL_AUX..AdvertsStack
SELECT  R.PK_AdvertId   AS  AdvertId, 
        2               AS  AdvertCategoryId,
        A.FK_ClientId   AS  ClientId,
        GETDATE()       AS  [Date],
        0               AS  Priority,
        0               AS  Attempts,
        0               AS  [Status]
FROM FC_COL_AUX..AdvertsStack S
    RIGHT JOIN FC_COL_WRT..AdvertsRealstate R ON S.AdvertId = R.PK_AdvertId
    INNER JOIN FC_COL_WRT..Adverts A ON R.PK_AdvertId = A.PK_AdvertId
WHERE R.Fk_Location3Id IN (7500101,7500102,7500103,7500104,7500105,7500106,7500107,7500108,7500109,7500110,7500111,7500112,7500113,7500114,7500115,7500116,7500117) 
    AND FK_Location4Id IN (7501001,7501002,7501005,7501007,7501008,7501009,7501010,7501011,7501012,7501013,7501014,7501015,7501016,7501017,7501018,7501019,7501020,7501021,7501022,7501023,7501024,7501025,7501026,7501027,7501028,7501029,7501030,7501031,7501032,7501033,7501034,7501035,7501036,7501037,7501038,7501039,7501040,7501041,7501042,7501043,7501045,7501047,7501053,7501054,7501057,7501059,7501060,7501061,7501062,7501063,7501064,7501065,7501066,7501067,7501068,7501069,7501070,7501071,7501072,7501073,7501074,7501075,7501078,7501079,7501080,7501081,7501082,7501083,7501084,7501085,7501086,7501087,7501089,7501090,7501091,7501097,7501099,7501100,7501102,7501103,7501104,7501105,7501106,7501107,7501108,7501109,7501110,7501111,7501112,7501113,7501114,7501115,7501116,7501117,7501118,7501119,7501120,7501121,7501122,7501123,7501125,7501127,7501128,7501129,7501130,7501134,7501136,7501137,7501138,7501139,7501140,7501142,7501143,7501144,7501145,7501146,7501147,7501149,7501150,7501153,7501158,7501161,7501162,7501170,7501176,7501177,7501178,7501179,7501180,7501181,7501182,7501183,7501184,7501185,7501190,7501191,7501192,7501193,7501194,7501195,7501196,7501197,7501198,7501199,7501200,7501201,7501202)
    AND S.AdvertId IS NULL
    AND A.[Status] = 2
