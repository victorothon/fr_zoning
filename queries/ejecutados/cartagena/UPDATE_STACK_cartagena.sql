
---------------------------------
-- UPDATE: OVFR_COL: AdvertsStack 
---------------------------------

-- Inmobiliarias

UPDATE DESTINO
SET Attempts         = 0,
    Fk_StatusStackId = 0,
    StackDate        = GETDATE(),
    Exception        = '',
    AlertType        = temp.AlertType
--SELECT *
FROM OVFR_COL..StackAd DESTINO
         INNER JOIN (
            SELECT A.Pk_Id AS Fk_AdId, 1 AS AlertType
            FROM OVFR_COL..Inmo I (NOLOCK)
                INNER JOIN OVFR_COL..Ad A (NOLOCK) ON A.Pk_Id = I.Pk_Id AND A.Fk_StatusId = 2
            WHERE A.Fk_LocalizationLevel4Id IN (5800101,5800102,5800103)
                AND A.Fk_LocalizationLevel5Id IN (5801001,5801002,5801003,5801004,5801005,5801006,5801007,5801008,5801009,5801010,5801011,5801012,5801013,5801014,5801015,5801016,5801017,5801018,5801019,5801020,5801021,5801022,5801023,5801024,5801025,5801026,5801027,5801028,5801029,5801030,5801031,5801032,5801033,5801034,5801035,5801036,5801037,5801038,5801039,5801040,5801041,5801042,5801043,5801044,5801045,5801046,5801047,5801048,5801049,5801050,5801051,5801052,5801053,5801054,5801055,5801056,5801057,5801058,5801059,5801060,5801061,5801062,5801063,5801064,5801065,5801066,5801067,5801068,5801069,5801070,5801071,5801072,5801073,5801074,5801075,5801076,5801077,5801078,5801079,5801080,5801081,5801082,5801083,5801084,5801085,5801086,5801087,5801088,5801089,5801090,5801091,5801092,5801093,5801094,5801095,5801096,5801097,5801098,5801099,5801100,5801101,5801102,5801103,5801104,5801105,5801106,5801107,5801108,5801109,5801110,5801111,5801112,5801113,5801114,5801115,5801116,5801117,5801118,5801119,5801120,5801121,5801122,5801123,5801124,5801125,5801126,5801127,5801128,5801129,5801130,5801131,5801132,5801133,5801134,5801135,5801136,5801137,5801138,5801139,5801140,5801141,5801142,5801143,5801144,5801145,5801146,5801147,5801148,5801149,5801150,5801151,5801152,5801153,5801154,5801155,5801156,5801157,5801158,5801159,5801160,5801161,5801162,5801163,5801164,5801165,5801166,5801167,5801168,5801169,5801170,5801171,5801172,5801173,5801174,5801175,5801176,5801177,5801178,5801179,5801180,5801181,5801182,5801183,5801184,5801185,5801186,5801187,5801188,5801189,5801190,5801191,5801192,5801193,5801194,5801195,5801196,5801197,5801198,5801199,5801200,5801201,5801202,5801203,5801204,5801205,5801206,5801207)
) AS TEMP ON TEMP.Fk_AdId = DESTINO.Fk_AdId 
            AND TEMP.AlertType = DESTINO.AlertType

-- Proyectos

UPDATE DESTINO
SET Attempts         = 0,
    Fk_StatusStackId = 0,
    StackDate        = GETDATE(),
    Exception        = '',
    AlertType        = temp.AlertType
FROM OVFR_COL..StackAd DESTINO
         INNER JOIN (
            SELECT A.Pk_Id AS Fk_AdId, 2 AS AlertType
            FROM OVFR_COL..Project P (NOLOCK)
                INNER JOIN OVFR_COL..Ad A ON A.Pk_Id = P.Pk_Id
            WHERE A.Fk_LocalizationLevel4Id IN (5800101,5800102,5800103) 
                AND A.Fk_LocalizationLevel5Id IN (5801001,5801002,5801003,5801004,5801005,5801006,5801007,5801008,5801009,5801010,5801011,5801012,5801013,5801014,5801015,5801016,5801017,5801018,5801019,5801020,5801021,5801022,5801023,5801024,5801025,5801026,5801027,5801028,5801029,5801030,5801031,5801032,5801033,5801034,5801035,5801036,5801037,5801038,5801039,5801040,5801041,5801042,5801043,5801044,5801045,5801046,5801047,5801048,5801049,5801050,5801051,5801052,5801053,5801054,5801055,5801056,5801057,5801058,5801059,5801060,5801061,5801062,5801063,5801064,5801065,5801066,5801067,5801068,5801069,5801070,5801071,5801072,5801073,5801074,5801075,5801076,5801077,5801078,5801079,5801080,5801081,5801082,5801083,5801084,5801085,5801086,5801087,5801088,5801089,5801090,5801091,5801092,5801093,5801094,5801095,5801096,5801097,5801098,5801099,5801100,5801101,5801102,5801103,5801104,5801105,5801106,5801107,5801108,5801109,5801110,5801111,5801112,5801113,5801114,5801115,5801116,5801117,5801118,5801119,5801120,5801121,5801122,5801123,5801124,5801125,5801126,5801127,5801128,5801129,5801130,5801131,5801132,5801133,5801134,5801135,5801136,5801137,5801138,5801139,5801140,5801141,5801142,5801143,5801144,5801145,5801146,5801147,5801148,5801149,5801150,5801151,5801152,5801153,5801154,5801155,5801156,5801157,5801158,5801159,5801160,5801161,5801162,5801163,5801164,5801165,5801166,5801167,5801168,5801169,5801170,5801171,5801172,5801173,5801174,5801175,5801176,5801177,5801178,5801179,5801180,5801181,5801182,5801183,5801184,5801185,5801186,5801187,5801188,5801189,5801190,5801191,5801192,5801193,5801194,5801195,5801196,5801197,5801198,5801199,5801200,5801201,5801202,5801203,5801204,5801205,5801206,5801207)
                AND A.Fk_StatusId = 2
) AS TEMP ON TEMP.Fk_AdId = DESTINO.Fk_AdId 
            AND TEMP.AlertType = DESTINO.AlertType

-- Tipologías

UPDATE DESTINO
SET Attempts         = 0,
    Fk_StatusStackId = 0,
    StackDate        = GETDATE(),
    Exception        = '',
    AlertType        = temp.AlertType
FROM OVFR_COL..StackAd DESTINO
         INNER JOIN (
            SELECT A.Pk_Id AS Fk_AdId, 2 as AlertType
            FROM OVFR_COL..Project P (NOLOCK)
                INNER JOIN OVFR_COL..Ad A ON A.Pk_Id = P.Pk_Id
                INNER JOIN OVFR_COL..UnitType U ON U.Fk_IdProject = A.Pk_Id 
            WHERE A.Fk_LocalizationLevel4Id IN (5800101,5800102,5800103)
                AND A.Fk_LocalizationLevel5Id IN (5801001,5801002,5801003,5801004,5801005,5801006,5801007,5801008,5801009,5801010,5801011,5801012,5801013,5801014,5801015,5801016,5801017,5801018,5801019,5801020,5801021,5801022,5801023,5801024,5801025,5801026,5801027,5801028,5801029,5801030,5801031,5801032,5801033,5801034,5801035,5801036,5801037,5801038,5801039,5801040,5801041,5801042,5801043,5801044,5801045,5801046,5801047,5801048,5801049,5801050,5801051,5801052,5801053,5801054,5801055,5801056,5801057,5801058,5801059,5801060,5801061,5801062,5801063,5801064,5801065,5801066,5801067,5801068,5801069,5801070,5801071,5801072,5801073,5801074,5801075,5801076,5801077,5801078,5801079,5801080,5801081,5801082,5801083,5801084,5801085,5801086,5801087,5801088,5801089,5801090,5801091,5801092,5801093,5801094,5801095,5801096,5801097,5801098,5801099,5801100,5801101,5801102,5801103,5801104,5801105,5801106,5801107,5801108,5801109,5801110,5801111,5801112,5801113,5801114,5801115,5801116,5801117,5801118,5801119,5801120,5801121,5801122,5801123,5801124,5801125,5801126,5801127,5801128,5801129,5801130,5801131,5801132,5801133,5801134,5801135,5801136,5801137,5801138,5801139,5801140,5801141,5801142,5801143,5801144,5801145,5801146,5801147,5801148,5801149,5801150,5801151,5801152,5801153,5801154,5801155,5801156,5801157,5801158,5801159,5801160,5801161,5801162,5801163,5801164,5801165,5801166,5801167,5801168,5801169,5801170,5801171,5801172,5801173,5801174,5801175,5801176,5801177,5801178,5801179,5801180,5801181,5801182,5801183,5801184,5801185,5801186,5801187,5801188,5801189,5801190,5801191,5801192,5801193,5801194,5801195,5801196,5801197,5801198,5801199,5801200,5801201,5801202,5801203,5801204,5801205,5801206,5801207)
                AND A.Fk_StatusId = 2
                AND U.Fk_IdProject <> 0
) AS TEMP ON TEMP.Fk_AdId = DESTINO.Fk_AdId 
            AND TEMP.AlertType = DESTINO.AlertType

---------------------------------
-- INSERT: OVFR_COL: AdvertsStack
---------------------------------

-- Inmobiliarias
INSERT INTO OVFR_COL..StackAd
SELECT TEMP.Pk_Id       AS      Fk_AdId,
       0                AS      Fk_UnitTypeId,
       2                AS      Fk_StatusStackId,
       GETDATE()        AS      StackDate,
       0                AS      Attempts,
       NULL             AS      Exception,
       TEMP.AlertType   AS      AlertType,
       NULL             AS      ReprocessedAfterError
FROM ( 
    SELECT A.Pk_Id AS Pk_Id, 1 AS AlertType
        FROM OVFR_COL..Inmo I (NOLOCK)
            INNER JOIN OVFR_COL..Ad A ON A.Pk_Id = I.Pk_Id
            LEFT JOIN OVFR_COL..StackAd S ON S.Fk_AdId = I.Pk_Id
        WHERE A.Fk_LocalizationLevel4Id IN (5800101,5800102,5800103)
            AND A.Fk_LocalizationLevel5Id IN (5801001,5801002,5801003,5801004,5801005,5801006,5801007,5801008,5801009,5801010,5801011,5801012,5801013,5801014,5801015,5801016,5801017,5801018,5801019,5801020,5801021,5801022,5801023,5801024,5801025,5801026,5801027,5801028,5801029,5801030,5801031,5801032,5801033,5801034,5801035,5801036,5801037,5801038,5801039,5801040,5801041,5801042,5801043,5801044,5801045,5801046,5801047,5801048,5801049,5801050,5801051,5801052,5801053,5801054,5801055,5801056,5801057,5801058,5801059,5801060,5801061,5801062,5801063,5801064,5801065,5801066,5801067,5801068,5801069,5801070,5801071,5801072,5801073,5801074,5801075,5801076,5801077,5801078,5801079,5801080,5801081,5801082,5801083,5801084,5801085,5801086,5801087,5801088,5801089,5801090,5801091,5801092,5801093,5801094,5801095,5801096,5801097,5801098,5801099,5801100,5801101,5801102,5801103,5801104,5801105,5801106,5801107,5801108,5801109,5801110,5801111,5801112,5801113,5801114,5801115,5801116,5801117,5801118,5801119,5801120,5801121,5801122,5801123,5801124,5801125,5801126,5801127,5801128,5801129,5801130,5801131,5801132,5801133,5801134,5801135,5801136,5801137,5801138,5801139,5801140,5801141,5801142,5801143,5801144,5801145,5801146,5801147,5801148,5801149,5801150,5801151,5801152,5801153,5801154,5801155,5801156,5801157,5801158,5801159,5801160,5801161,5801162,5801163,5801164,5801165,5801166,5801167,5801168,5801169,5801170,5801171,5801172,5801173,5801174,5801175,5801176,5801177,5801178,5801179,5801180,5801181,5801182,5801183,5801184,5801185,5801186,5801187,5801188,5801189,5801190,5801191,5801192,5801193,5801194,5801195,5801196,5801197,5801198,5801199,5801200,5801201,5801202,5801203,5801204,5801205,5801206,5801207)
            AND S.Fk_AdId IS NULL
            AND A.Fk_StatusId = 2
    ) AS TEMP

-- Proyectos

INSERT INTO OVFR_COL..StackAd
SELECT TEMP.Pk_Id       AS      Fk_AdId,
       0                AS      Fk_UnitTypeId,
       2                AS      Fk_StatusStackId,
       GETDATE()        AS      StackDate,
       0                AS      Attempts,
       NULL             AS      Exception,
       TEMP.AlertType   AS      AlertType,
       NULL             AS      ReprocessedAfterError
FROM (
    SELECT A.Pk_Id AS Pk_Id, 2 AS AlertType
    FROM OVFR_COL..Project P (NOLOCK)
        INNER JOIN OVFR_COL..Ad A ON A.Pk_Id = P.Pk_Id
        LEFT JOIN OVFR_COL..StackAd S ON S.Fk_AdId = A.Pk_Id
    WHERE A.Fk_LocalizationLevel4Id IN (5800101,5800102,5800103)
        AND A.Fk_LocalizationLevel5Id IN (5801001,5801002,5801003,5801004,5801005,5801006,5801007,5801008,5801009,5801010,5801011,5801012,5801013,5801014,5801015,5801016,5801017,5801018,5801019,5801020,5801021,5801022,5801023,5801024,5801025,5801026,5801027,5801028,5801029,5801030,5801031,5801032,5801033,5801034,5801035,5801036,5801037,5801038,5801039,5801040,5801041,5801042,5801043,5801044,5801045,5801046,5801047,5801048,5801049,5801050,5801051,5801052,5801053,5801054,5801055,5801056,5801057,5801058,5801059,5801060,5801061,5801062,5801063,5801064,5801065,5801066,5801067,5801068,5801069,5801070,5801071,5801072,5801073,5801074,5801075,5801076,5801077,5801078,5801079,5801080,5801081,5801082,5801083,5801084,5801085,5801086,5801087,5801088,5801089,5801090,5801091,5801092,5801093,5801094,5801095,5801096,5801097,5801098,5801099,5801100,5801101,5801102,5801103,5801104,5801105,5801106,5801107,5801108,5801109,5801110,5801111,5801112,5801113,5801114,5801115,5801116,5801117,5801118,5801119,5801120,5801121,5801122,5801123,5801124,5801125,5801126,5801127,5801128,5801129,5801130,5801131,5801132,5801133,5801134,5801135,5801136,5801137,5801138,5801139,5801140,5801141,5801142,5801143,5801144,5801145,5801146,5801147,5801148,5801149,5801150,5801151,5801152,5801153,5801154,5801155,5801156,5801157,5801158,5801159,5801160,5801161,5801162,5801163,5801164,5801165,5801166,5801167,5801168,5801169,5801170,5801171,5801172,5801173,5801174,5801175,5801176,5801177,5801178,5801179,5801180,5801181,5801182,5801183,5801184,5801185,5801186,5801187,5801188,5801189,5801190,5801191,5801192,5801193,5801194,5801195,5801196,5801197,5801198,5801199,5801200,5801201,5801202,5801203,5801204,5801205,5801206,5801207)
        AND S.Fk_AdId IS NULL
        AND A.Fk_StatusId = 2
    ) AS TEMP

-- Tipologías

INSERT INTO OVFR_COL..StackAd
SELECT TEMP.Pk_AdId         AS      Fk_AdId,
       TEMP.Fk_UnitTypeId   AS      Fk_UnitTypeId,
       2                    AS      Fk_StatusStackId,
       GETDATE()            AS      StackDate,
       0                    AS      Attempts,
       NULL                 AS      Exception,
       TEMP.AlertType       AS      AlertType,
       NULL                 AS      ReprocessedAfterError
FROM 
      (
        SELECT A.Pk_Id AS Pk_AdId, U.Pk_Id Fk_UnitTypeId, 2 as AlertType
        FROM OVFR_COL..Ad A (NOLOCK)
            INNER JOIN OVFR_COL..Project P ON A.Pk_Id = P.Pk_Id
            INNER JOIN OVFR_COL..UnitType U ON U.Fk_IdProject = A.Pk_Id
            LEFT JOIN OVFR_COL..StackAd S ON S.Fk_AdId = A.Pk_Id AND S.Fk_UnitTypeId = U.Pk_Id
            WHERE A.Fk_LocalizationLevel4Id IN (5800101,5800102,5800103) 
                AND A.Fk_LocalizationLevel5Id IN (5801001,5801002,5801003,5801004,5801005,5801006,5801007,5801008,5801009,5801010,5801011,5801012,5801013,5801014,5801015,5801016,5801017,5801018,5801019,5801020,5801021,5801022,5801023,5801024,5801025,5801026,5801027,5801028,5801029,5801030,5801031,5801032,5801033,5801034,5801035,5801036,5801037,5801038,5801039,5801040,5801041,5801042,5801043,5801044,5801045,5801046,5801047,5801048,5801049,5801050,5801051,5801052,5801053,5801054,5801055,5801056,5801057,5801058,5801059,5801060,5801061,5801062,5801063,5801064,5801065,5801066,5801067,5801068,5801069,5801070,5801071,5801072,5801073,5801074,5801075,5801076,5801077,5801078,5801079,5801080,5801081,5801082,5801083,5801084,5801085,5801086,5801087,5801088,5801089,5801090,5801091,5801092,5801093,5801094,5801095,5801096,5801097,5801098,5801099,5801100,5801101,5801102,5801103,5801104,5801105,5801106,5801107,5801108,5801109,5801110,5801111,5801112,5801113,5801114,5801115,5801116,5801117,5801118,5801119,5801120,5801121,5801122,5801123,5801124,5801125,5801126,5801127,5801128,5801129,5801130,5801131,5801132,5801133,5801134,5801135,5801136,5801137,5801138,5801139,5801140,5801141,5801142,5801143,5801144,5801145,5801146,5801147,5801148,5801149,5801150,5801151,5801152,5801153,5801154,5801155,5801156,5801157,5801158,5801159,5801160,5801161,5801162,5801163,5801164,5801165,5801166,5801167,5801168,5801169,5801170,5801171,5801172,5801173,5801174,5801175,5801176,5801177,5801178,5801179,5801180,5801181,5801182,5801183,5801184,5801185,5801186,5801187,5801188,5801189,5801190,5801191,5801192,5801193,5801194,5801195,5801196,5801197,5801198,5801199,5801200,5801201,5801202,5801203,5801204,5801205,5801206,5801207)
                AND S.Fk_AdId Is NULL
                AND A.Fk_StatusId = 2
        ) AS TEMP
    

--------------------------
--------------------------
--FC Stack Update & Insert
--------------------------
--------------------------

-- Update

UPDATE Destino
SET [Date] = GETDATE(),
    [Priority] = 0,
    [Attempts] = 0,
    [Status] = 0 
FROM FC_COL_AUX..AdvertsStack Destino
    INNER JOIN (
        SELECT MAX(S.PK_AdvertsStackId) PK_AdvertsStackId, S.AdvertId
        FROM FC_COL_AUX..AdvertsStack S
            INNER JOIN FC_COL_WRT..AdvertsRealstate R ON S.AdvertId = R.PK_AdvertId
            INNER JOIN FC_COL_WRT..Adverts A ON R.PK_AdvertId = A.PK_AdvertId
        WHERE R.Fk_Location3Id IN (5800101,5800102,5800103)
            AND R.FK_Location4Id IN (5801001,5801002,5801003,5801004,5801005,5801006,5801007,5801008,5801009,5801010,5801011,5801012,5801013,5801014,5801015,5801016,5801017,5801018,5801019,5801020,5801021,5801022,5801023,5801024,5801025,5801026,5801027,5801028,5801029,5801030,5801031,5801032,5801033,5801034,5801035,5801036,5801037,5801038,5801039,5801040,5801041,5801042,5801043,5801044,5801045,5801046,5801047,5801048,5801049,5801050,5801051,5801052,5801053,5801054,5801055,5801056,5801057,5801058,5801059,5801060,5801061,5801062,5801063,5801064,5801065,5801066,5801067,5801068,5801069,5801070,5801071,5801072,5801073,5801074,5801075,5801076,5801077,5801078,5801079,5801080,5801081,5801082,5801083,5801084,5801085,5801086,5801087,5801088,5801089,5801090,5801091,5801092,5801093,5801094,5801095,5801096,5801097,5801098,5801099,5801100,5801101,5801102,5801103,5801104,5801105,5801106,5801107,5801108,5801109,5801110,5801111,5801112,5801113,5801114,5801115,5801116,5801117,5801118,5801119,5801120,5801121,5801122,5801123,5801124,5801125,5801126,5801127,5801128,5801129,5801130,5801131,5801132,5801133,5801134,5801135,5801136,5801137,5801138,5801139,5801140,5801141,5801142,5801143,5801144,5801145,5801146,5801147,5801148,5801149,5801150,5801151,5801152,5801153,5801154,5801155,5801156,5801157,5801158,5801159,5801160,5801161,5801162,5801163,5801164,5801165,5801166,5801167,5801168,5801169,5801170,5801171,5801172,5801173,5801174,5801175,5801176,5801177,5801178,5801179,5801180,5801181,5801182,5801183,5801184,5801185,5801186,5801187,5801188,5801189,5801190,5801191,5801192,5801193,5801194,5801195,5801196,5801197,5801198,5801199,5801200,5801201,5801202,5801203,5801204,5801205,5801206,5801207)
            AND A.[Status] = 2
        GROUP BY S.AdvertId
    ) AS TEMP ON TEMP.PK_AdvertsStackId = Destino.PK_AdvertsStackId

-- Insert

INSERT INTO FC_COL_AUX..AdvertsStack
SELECT  R.PK_AdvertId   AS  AdvertId, 
        2               AS  AdvertCategoryId,
        A.FK_ClientId   AS  ClientId,
        GETDATE()       AS  [Date],
        0               AS  Priority,
        0               AS  Attempts,
        0               AS  [Status]
FROM FC_COL_AUX..AdvertsStack S (NOLOCK)
    RIGHT JOIN FC_COL_WRT..AdvertsRealstate R ON S.AdvertId = R.PK_AdvertId
    INNER JOIN FC_COL_WRT..Adverts A ON R.PK_AdvertId = A.PK_AdvertId
WHERE R.Fk_Location3Id IN (5800101,5800102,5800103) 
    AND FK_Location4Id IN (5801001,5801002,5801003,5801004,5801005,5801006,5801007,5801008,5801009,5801010,5801011,5801012,5801013,5801014,5801015,5801016,5801017,5801018,5801019,5801020,5801021,5801022,5801023,5801024,5801025,5801026,5801027,5801028,5801029,5801030,5801031,5801032,5801033,5801034,5801035,5801036,5801037,5801038,5801039,5801040,5801041,5801042,5801043,5801044,5801045,5801046,5801047,5801048,5801049,5801050,5801051,5801052,5801053,5801054,5801055,5801056,5801057,5801058,5801059,5801060,5801061,5801062,5801063,5801064,5801065,5801066,5801067,5801068,5801069,5801070,5801071,5801072,5801073,5801074,5801075,5801076,5801077,5801078,5801079,5801080,5801081,5801082,5801083,5801084,5801085,5801086,5801087,5801088,5801089,5801090,5801091,5801092,5801093,5801094,5801095,5801096,5801097,5801098,5801099,5801100,5801101,5801102,5801103,5801104,5801105,5801106,5801107,5801108,5801109,5801110,5801111,5801112,5801113,5801114,5801115,5801116,5801117,5801118,5801119,5801120,5801121,5801122,5801123,5801124,5801125,5801126,5801127,5801128,5801129,5801130,5801131,5801132,5801133,5801134,5801135,5801136,5801137,5801138,5801139,5801140,5801141,5801142,5801143,5801144,5801145,5801146,5801147,5801148,5801149,5801150,5801151,5801152,5801153,5801154,5801155,5801156,5801157,5801158,5801159,5801160,5801161,5801162,5801163,5801164,5801165,5801166,5801167,5801168,5801169,5801170,5801171,5801172,5801173,5801174,5801175,5801176,5801177,5801178,5801179,5801180,5801181,5801182,5801183,5801184,5801185,5801186,5801187,5801188,5801189,5801190,5801191,5801192,5801193,5801194,5801195,5801196,5801197,5801198,5801199,5801200,5801201,5801202,5801203,5801204,5801205,5801206,5801207)
    AND S.AdvertId IS NULL
    AND A.[Status] = 2
